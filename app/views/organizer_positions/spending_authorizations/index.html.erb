<% title "Spending auths for #{@user.name}" %>
<% page_md %>
<%= render "events/nav", selected: :reimbursements %>

<h1 class="heading flex">
  <span style="flex"><%= @user.name %>'s Spending Controls</span>
  <%= link_to "#", class: "btn bg-success", data: { behavior: "modal_trigger", modal: "new" } do %>
    <%= inline_icon "docs" %>
    New
  <% end %>
</h1>

<div class="modal modal--scroll bg-snow" data-behavior="modal" role="dialog" id="new">
  <%= modal_header "New spending authorization" %>
  <%= render "form" %>
</div>

<div class="statset mt3 mb2">
  <div class="stat stat--small">
    <span class="stat__label">Balance</span>
    <span class="stat__value">
      ???
    </span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">Total Allocated</span>
    <span class="stat__value">
      <%= render_money_amount @op.spending_authorizations.sum(:amount_cents) %>
    </span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">Spent</span>
    <span class="stat__value">
      ???
    </span>
  </div>
</div>

<hr>

<div class="flex g2 items-center">
  <%= form_with(model: nil, local: true, method: :get, class: "grow") do |form| %>
    <div class="filterbar flex flex-wrap items-center width-100">
      <%= form.text_field :q, placeholder: "Searchâ€¦", class: "flex-auto md-mr2", style: "width auto; max-width: none;", value: params[:q] %>
    </div>
  <% end %>

  <div style="text-align: center;">
    <%= link_to "All", "?filter=all", class: "filterbar__item", "aria-selected": !["reimbursed", "pending", "rejected"].include?(params[:filter]), role: "tab" %>
    <%= link_to "Authorizations", "?filter=authorizations", class: "filterbar__item", "aria-selected": params[:filter] == "positive", role: "tab" %>
    <%= link_to "Transactions", "?filter=negative", class: "filterbar__item", "aria-selected": params[:filter] == "negative", role: "tab" %>
  </div>
</div>

<% if @op.spending_authorizations.blank? %>
  <%= blankslate "No spending authorizations yet" %>
<% else %>
  <article class="table-container">
    <table>
      <thead>
      <tr>
        <th>Amount</th>
        <th>Memo</th>
        <th>Authorized by</th>
        <th>Created</th>
      </tr>
      </thead>
      <tbody>
        <% @op.spending_authorizations.order(created_at: :desc).each do |authorization| %>
          <tr>
            <td>
              <%= render_money authorization.amount_cents %>
            </td>
            <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">
              <%= authorization.memo %>
            </td>
            <td class="flex items-center g1">
              <%= avatar_for authorization.authorized_by.user, 24 %>
              <%= authorization.authorized_by.user.name %>
            </td>
            <td>
              <%= format_date authorization.created_at %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </article>
<% end %>
