<% title "Spending auths for #{@user.name}" %>
<% page_md %>
<%= render "events/nav" %>

<h1 class="heading flex">
  <span style="flex"><%= @user.name %>'s Spending</span>

  <% if @controls_enabled %>
    <%= link_to "#", class: "btn bg-success", data: { behavior: "modal_trigger", modal: "new" } do %>
      <%= inline_icon "docs" %>
      New
    <% end %>
  <% end %>
</h1>

<div class="modal modal--scroll bg-snow" data-behavior="modal" role="dialog" id="new">
  <%= modal_header "New spending authorization" %>
  <%= render "form" %>
</div>

<%= @op.spending_controls.count %> spending controls,
<%= @op.active_spending_control ? "one" : "none" %> active

<div class="statset mt3 mb2">
  <div class="stat stat--small">
    <span class="stat__label">Balance</span>
    <span class="stat__value">
      <%= render_money_amount @authorization_balance %>
    </span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">Total Allocated</span>
    <span class="stat__value">
      <%= render_money_amount @authorizations_total %>
    </span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">Spent</span>
    <span class="stat__value">
      <%= render_money_amount @transactions_total %>
    </span>
  </div>
</div>

<% spending_controls_callout_footer = capture do %>
  <% if @op.active_spending_control %>
    <%= link_to new_event_organizer_control_path(@event, @op), class: "btn btn-small bg-error", method: :delete do %>
      <%= inline_icon "forbidden" %>
      Disable controls for <%= @op.user.first_name %>
    <% end %>
  <% else %>
    <%= link_to new_event_organizer_control_path(@event, @op), class: "btn btn-small bg-info" do %>
      Enable controls for <%= @op.user.first_name %>
    <% end %>
  <% end %>
<% end %>
<%= render "callout", type: "info", title: "Spending controls are enabled for #{@op.user.first_name}.", footer: spending_controls_callout_footer  do %>
  <ul>
    <li>Spending controls lets managers pre-authorize a defined portion of your organization's fund to be spent by a user.</li>
    <li>Your organization's balance will not change when an allowance is created.</li>
    <li>Allowances do not expire.
  </ul>
<% end %>

<div class="flex g2 items-center">
  <%= form_with(model: nil, local: true, method: :get, class: "grow") do |form| %>
    <div class="filterbar flex flex-wrap items-center width-100">
      <%= form.text_field :q, placeholder: "Searchâ€¦", class: "flex-auto md-mr2", style: "width auto; max-width: none;", value: params[:q] %>
    </div>
  <% end %>

  <div style="text-align: center;">
    <%= link_to "All", "?filter=all", class: "filterbar__item", "aria-selected": !["allowances", "transactions"].include?(params[:filter]), role: "tab" %>
    <%= link_to "Allowances", "?filter=allowances", class: "filterbar__item", "aria-selected": params[:filter] == "allowances", role: "tab" %>
    <%= link_to "Transactions", "?filter=transactions", class: "filterbar__item", "aria-selected": params[:filter] == "transactions", role: "tab" %>
  </div>
</div>

<% active_control = @op.active_spending_control %>
<% if !active_control %>
  <%= blankslate "No active control" %>
<% elsif active_control.organizer_position_spending_allowances.blank? %>
  <%= blankslate "No allowances yet" %>
<% else %>
  <%= render_spending_items sorted_spending_items(active_control) %>
<% end %>

<h2>Past controls</h2>
<% @op.spending_controls.filter { |c| !c.active }.sort_by(&:created_at).reverse.each do |c| %>
  <h3>Control from <%= format_date c.created_at %> through <%= format_date c.ended_at %></h3>

  <%= render_spending_items sorted_spending_items(c) %>
<% end %>
