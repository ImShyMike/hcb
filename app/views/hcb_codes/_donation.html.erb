<% @donation = @hcb_code.donation %>

<% title "#{render_money(@donation.amount)} donation to #{@donation.event.name}" %>

<%= render partial: 'admin_viewer', locals: { record: @donation } %>
<%= render partial: 'admin_viewer', locals: { record: @donation.payout } unless @donation.payout.nil? %>

<% admin_tools('mt3') do %>
  <%= link_to 'View on Stripe', @donation.stripe_dashboard_url, class: 'btn bg-accent' %>
  <%= link_to 'Issue refund', refund_donation_path(@donation), method: :post, class: 'btn bg-error' if @donation.deposited? %>
<% end %>

<article class="card pb0 mt3 mb0">
  <h2 class="h2 mt0 border-none flex items-center justify-between">
    <span>
      <%= @donation.name %>
      <span class="regular muted"> donated </span>
      <span class="regular"><%= render_money @donation.amount_received %></span>
      <% if @donation.refunded? %>
        <span class="regular muted">and was later refunded</span>
      <% end %>
    </span>

    <span class="md-right flex flex-row">
      <span class="badge h4 bg-<%= @donation.state %> nowrap">
        <%= @donation.state_text %>
        <%= inline_icon @donation.state_icon, size: 20 if @donation.state_icon %>
      </span>
      
      <% if @donation.in_transit? %>
        <span class="<%= 'cursor-pointer tooltipped tooltipped--w' if @donation.in_transit? %> ml1 muted"
              aria-label="Request to expedite incoming funds"
              data-behavior="<%= 'modal_trigger' if @donation.in_transit? %>"
              data-modal="<%= 'request_front' if @donation.in_transit? %>"
        >
          <%= inline_icon 'bolt', class: 'pop' %>
        </span>
      <% end %>
    </span>
  </h2>

  <% if @donation.in_transit? %>
    <section class="modal modal--scroll bg-snow" data-behavior="modal" role="dialog" id="request_front">
      <%= modal_header 'Request fronted funds' %>
      <p>
        Incoming funds typically take a few days to settle, and we understand there are situations where you may need access to funds sooner.
        <span class="muted">
          (<%= link_to 'learn more', "https://headwayapp.co/bank-changelog/instant-transfers-emergency-funds-235516" %>)
        </span>
      </p>
      <div class="border-top pt1 secondary">
        <div class="flex items-center warning">
          <%= inline_icon 'info', size: 32, class: 'mr1' %>
          <p class="bold mt0 mb0">If you request fronted funds, please keep in mind:</p>
        </div>
        <ul class="mt1 mb2">
          <li>For a quicker response, <strong>include your phone number</strong>.</li>
          <li>Requests take a business day to review.</li>
          <li>Your event should be running on or before <em><%= format_date Time.now + 7.days %></em>.</li>
          <li>We only front <strong>already paid, in transit donations</strong>.</li>
        </ul>
      </div>
      <a class="btn"
         href="mailto:bank@hackclub.com?subject=Request%20to%20Expedite%20Incoming%20Payment&body=I%20am%20requesting%20to%20expedite%20the%20transfer%20of%20<%= url_encode(Rails.application.routes.url_helpers.root_url + @hcb_code.url) %>%20for%20the%20following%20reason"
         target="_blank"
      >
        Request
      </a>
    </section>
  <% end %>

  <section class="card__banner card__darker details-horiz border-top border-bottom">
    <% if @donation.payment_method_type == 'card' %>
      <action data-behavior="modal_trigger" data-modal="payment_details" class="details-horiz__col pointer" tabindex="0">
        <strong>
          <%# Nested tag to avoid flexbox-induced full-width strong leading to icon on right edge on mobile %>
          <span class="inline-flex items-start relative" style="padding-right: 28px;">
            Payment method
            <%= inline_icon 'external', size: 24, class: 'muted ml1 absolute right-0', 'aria-label': 'Icon indicating click for more' %>
          </span>
        </strong>
        <span class="inline-flex">
          <%= donation_payment_method_mention %>
        </span>
      </action>
    <% else %>
      <p>
        <strong>Payment method</strong>
        <span class="inline-flex">
          <%= donation_payment_method_mention %>
        </span>
      </p>
    <% end %>
    <p>
      <strong>Donated at</strong>
      <%= format_datetime @donation.created_at %>
    </p>
    <%= donation_payout_datetime %>
  </section>
  <% if @donation.payout %>
    <section class="pt2 pb2 details">
      <p>
        <strong>Donor email</strong>
        <% if organizer_signed_in? %>
          <%= mail_to @donation.email, @donation.email.downcase, class: 'slate underline' %>
        <% else %>
          <strong>Sign in to view</strong>
        <% end %>
      </p>
      <p>
        <strong>Amount</strong>
        +<%= render_money @donation.amount %>
      </p>
      <p>
        <strong><%= donation_fee_type(@donation) %></strong>
        -<%= donation_payment_processor_fee(true, @donation) %>
      </p>
      <p>
        <strong>Processing fee refund</strong>
        <span>
          +<%= donation_payment_processor_fee(true, @donation) %>
          <span class="muted">
            <% 'Pending ' unless @donation&.fee_reimbursement&.t_transaction %>
            (<%= link_to 'learn more', "https://changelog.bank.hackclub.com/we're-making-payment-processing-fees-disappear-101088" %>)
          </span>
        </span>
      </p>
    </section>
  <% end %>
</article>
<%= render partial: "hcb_codes/dispute", locals: { type: 'donation', hcb_code: @hcb_code } %>

<% if @donation.payment_method_type == 'card' %>
  <section class="modal modal--scroll bg-snow" data-behavior="modal" role="dialog" id="payment_details">
    <%= modal_header 'Payment details' + content_tag(:span, '', class: 'pl2') + donation_payment_method_mention(@donation, class: 'h3 sans slate regular') %>

    <article class="details-horiz">
      <div class="details">
        <p>
          <strong>Payment type</strong>
          <%= @donation.payment_method_card_funding.humanize.capitalize %>
        </p>
        <p>
          <strong>Brand</strong>
          <%= @donation.payment_method_card_brand.humanize.capitalize %>
        </p>
        <p>
          <strong>Expiration</strong>
          <% if organizer_signed_in? %>
            <%= @donation.payment_method_card_exp_month.to_s.rjust(2, '0') %> / <%= @donation.payment_method_card_exp_year %>
          <% else %>
            MM / YYYY (Sign in to view)
          <% end %>
        </p>
      </div>
      <div class="mt1 md-mt0">
        <p class="details__simulated">
          <%= donation_card_country_mention %>
          <span>Payment country</span>
        </p>
        <p class="details__simulated">
          <%= donation_card_check_badge 'cvc' %>
          <span>CVC check</span>
        </p>
        <p class="details__simulated">
          <%= donation_card_check_badge 'address_postal_code' %>
          <span>Zip check</span>
        </p>
      </div>
    </article>
  </section>
<% end %>
