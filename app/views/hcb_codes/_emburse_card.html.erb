<% title "#{render_money(-@hcb_code.amount_cents)} charge for #{@hcb_code.memo}" %>

<% admin_tools('mt1') do %>
  <%= link_to 'View on Emburse', @hcb_code.emburse_dashboard_url, class: 'btn bg-accent' %>
<% end %>

<% @hcb_code.canonical_pending_transactions.each do |pt| %>
<%= render partial: 'admin_viewer', locals: { record: pt } %>
<%= render partial: 'admin_viewer', locals: { record: pt.raw_pending_stripe_transaction } %>
<% end %>
<% @hcb_code.canonical_transactions.each do |ct| %>
<%= render partial: 'admin_viewer', locals: { record: ct } %>
<% end %>

<div class="mt2 mb3">
<article class="card pb0 mt3 mb1">

  <h2 class="h2 mt0 mx0 border-none flex items-center justify-between">
    <span>
      <%= @hcb_code.memo %>
      <span class="regular muted"> for </span>
      <%= number_to_currency(-@hcb_code.amount) %>
      </span>

      <% if @hcb_code.ct.raw_emburse_transaction.emburse_transaction["state"] == "declined" %>
        <span class="badge h4 md-right bg-accent">
          Declined
          <%= inline_icon :info, size: 20 %>
        </span>
      <% end %>
    </h2>

    <section class="card__banner card__darker details-horiz border-top border-bottom">
      <p>
        <strong>Card</strong>
        <%= emburse_card_mention @hcb_code.emburse_card %>
      </p>
      <p>
        <strong>Spender</strong>
        <%= link_to @hcb_code.emburse_card do %>
          <%= user_mention @hcb_code.emburse_card.user %>
        <% end %>
      </p>
      <p>
        <strong>Spent</strong>
        <%= local_time_ago @hcb_code.ct.raw_emburse_transaction.emburse_transaction["time"] %>
      </p>
    </section>

    <section class="details details--wide pt2 pb2 details--tall">
      <% if @hcb_code.ct.raw_emburse_transaction.emburse_transaction["state"] == "declined" %>
      <p>
      <strong>Declined</strong>
      <span><em>This transaction was declined.</em></span>
      </p>
      <% end %>
      <p>
        <strong>Merchant</strong>
        <% if organizer_signed_in? %>
            <action data-behavior="modal_trigger" data-modal="merchant_details" class="pointer" tabindex="0">
              <span class="inline-flex">
                <%= country_to_emoji @hcb_code.ct.raw_emburse_transaction.emburse_transaction["merchant"]["country"] %>
                <%= @hcb_code.ct.raw_emburse_transaction.emburse_transaction["merchant"]["name"] %>
              <%= inline_icon 'external', size: 24, class: 'muted', 'aria-label': 'Icon indicating click for more' %>
              </span>
            </action>
        <% else %>
          <span><strong>Sign in to view</strong></span>
        <% end %>
      </p>
    </section>

    <% if @hcb_code.receipts.any? %>
      <p class="card__banner bg-success white bold flex items-center mt0 mb0">
        <%= inline_icon "checkmark", size: 24, class: "mr2" %>
        <%= pluralize @hcb_code.receipts.count, "receipt" %>
        added
      </p>
    <% elsif @hcb_code.no_or_lost_receipt? %>
      <p class="card__banner bg-muted white bold flex items-center mt0 mb0">
        <%= inline_icon "view-close", size: 24, class: "mr2" %>
        Marked no/lost receipt
      </p>
    <% elsif @hcb_code.ct.raw_emburse_transaction.emburse_transaction["state"] == "declined" %>
      <p class="card__banner bg-muted white bold flex items-center mt0 mb0">
        <%= inline_icon "important", size: 24, class: "mr2" %>
        This transaction has no receipt
      </p>
    <% else %>
      <p class="card__banner bg-pending slate bold flex items-center mt0 mb0">
        <%= inline_icon "important", size: 24, class: "mr2" %>
        This transaction is missing a receipt
      </p>
    <% end %>

  </article>
  <%= render partial: "hcb_codes/dispute", locals: { type: 'card', hcb_code: @hcb_code } %>
</div>

<% if organizer_signed_in? %>
<section class="modal modal--scroll bg-snow" data-behavior="modal" role="dialog" id="merchant_details">
  <%= modal_header 'Merchant details' %>
  <% @merchant_data = @hcb_code.ct.raw_emburse_transaction.emburse_transaction["merchant"] %>

  <div class="details mb2">
    <p>
      <strong>Name</strong>
      <span>
        <%= @merchant_data["name"].humanize.capitalize %>
      </span>
    </p>
    <% if is_city_or_phone?(@merchant_data["city"]) == :phone %>
      <p>
        <strong>Phone</strong>
        <span><%= (@merchant_data["city"]) %></span>
      </p>
    <% elsif is_city_or_phone?(@merchant_data["city"]) == :city %>
      <p>
        <strong>City</strong>
        <span><%= (@merchant_data["city"]).humanize %></span>
      </p>
    <% end %>
    <p>
      <strong>Zip</strong>
      <span><%= (@merchant_data["zip"] or "Unknown") %></span>
    </p>
    <p>
      <strong>State</strong>
      <span><%= (@merchant_data["state"]&.upcase or "Unknown") %></span>
    </p>
    <p>
      <strong>Country</strong>
      <span><%= country_to_emoji @merchant_data["country"] %></span>
    </p>
  </div>
  <article class="card__banner secondary border-top" style="margin: -2em; margin-top: 0;">
    <p class="my0 muted">
      Details are provided by the merchant and not guaranteed to be correct.
    </p>
  </article>
</section>
<% end %>
