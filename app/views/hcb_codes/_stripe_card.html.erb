<% title "#{render_money(-@hcb_code.amount_cents)} charge for #{@hcb_code.memo}" %>

<% admin_tools('mt1') do %>
  <%= link_to 'View on Stripe', @hcb_code.stripe_auth_dashboard_url, class: 'btn bg-accent' %>
<% end %>

<% @hcb_code.canonical_pending_transactions.each do |pt| %>
<%= render partial: 'admin_viewer', locals: { record: pt } %>
<%= render partial: 'admin_viewer', locals: { record: pt.raw_pending_stripe_transaction } %>
<% end %>
<% @hcb_code.canonical_transactions.each do |pt| %>
<%= render partial: 'admin_viewer', locals: { record: pt } %>
<% end %>

<div class="mt2 mb3">
<article class="card pb0 mt3 mb1">

  <h2 class="h2 mt0 mx0 border-none flex items-center justify-between">
    <span>
      <%= @hcb_code.memo %>
      <span class="regular muted"> for </span>
      <%= number_to_currency(-@hcb_code.amount) %>
      </span>

      <% if @hcb_code.pt.declined? %>
        <span class="badge h4 md-right bg-accent">
          Declined
          <%= inline_icon :info, size: 20 %>
        </span>
      <% end %>
      <% if @hcb_code.pt.unsettled? %>
        <span class="badge h4 md-right bg-muted">
          Pending
          <%= inline_icon :info, size: 20 %>
        </span>
      <% end %>
    </h2>

    <section class="card__banner card__darker details-horiz border-top border-bottom">
      <p>
        <strong>Card</strong>
        <%= stripe_card_mention @hcb_code.stripe_card %>
      </p>
      <p>
        <strong>Spender</strong>
        <%= link_to @hcb_code.stripe_card do %>
          <%= user_mention @hcb_code.stripe_card.user %>
        <% end %>
      </p>
      <p>
        <strong>Spent</strong>
        <%= local_time_ago @hcb_code.pt.raw_pending_stripe_transaction.created_at %>
      </p>
      <% unless @hcb_code.ct.nil? %>
        <p>
          <strong>Settled after</strong>
          <span title="<%= Time.at(@hcb_code.ct.raw_stripe_transaction.stripe_transaction["created"]).strftime('%B %e, %Y %l:%M%P') %>">
          <%= distance_of_time_in_words @hcb_code.pt.raw_pending_stripe_transaction.created_at, @hcb_code.ct.created_at %>
          </span>
        </p>
      <% end %>
    </section>

    <section class="details details--wide pt2 pb2 details--tall">
      <% if @hcb_code.pt.declined? %>
      <p>
      <strong>Declined</strong>
      <span><em>This transaction was declined.</em></span>
      </p>
      <% end %>
      <% if @hcb_code.pt.unsettled? %>
      <p>
      <strong>Pending</strong>
      <span><em>This transaction is still pending, the amount may be more or less than shown here.</em></span>
      </p>
      <% end %>
      <p>
        <strong>Merchant</strong>
        <% if organizer_signed_in? %>
            <action data-behavior="modal_trigger" data-modal="merchant_details" class="pointer" tabindex="0">
              <span class="inline-flex">
                <%= country_to_emoji @hcb_code.pt.raw_pending_stripe_transaction.stripe_transaction["merchant_data"]["country"] %>
                <%= @hcb_code.pt.raw_pending_stripe_transaction.stripe_transaction["merchant_data"]["name"] %>
              <%= inline_icon 'external', size: 24, class: 'muted', 'aria-label': 'Icon indicating click for more' %>
              </span>
            </action>
        <% else %>
          <span><strong>Sign in to view</strong></span>
        <% end %>
      </p>
      <p>
        <strong>Charge method</strong>
        <% if organizer_signed_in? %>
            <action data-behavior="modal_trigger" data-modal="verification_details" class="pointer" tabindex="0">
              <span>
              <%= @hcb_code.pt.raw_pending_stripe_transaction.stripe_transaction["authorization_method"].humanize %>
              <%= inline_icon 'external', size: 24, class: 'muted', 'aria-label': 'Icon indicating click for more' %>
              </span>
            </action>
        <% else %>
          <span><strong>Sign in to view</strong></span>
        <% end %>
      </p>
    </section>

    <% if @hcb_code.receipts.any? %>
      <p class="card__banner bg-success white bold flex items-center mt0 mb0">
        <%= inline_icon "checkmark", size: 24, class: "mr2" %>
        <%= pluralize @hcb_code.receipts.count, "receipt" %>
        added
      </p>
    <% elsif @hcb_code.no_or_lost_receipt? %>
      <p class="card__banner bg-muted white bold flex items-center mt0 mb0">
        <%= inline_icon "view-close", size: 24, class: "mr2" %>
        Marked no/lost receipt
      </p>
    <% elsif @hcb_code.pt.declined? %>
      <p class="card__banner bg-muted white bold flex items-center mt0 mb0">
        <%= inline_icon "important", size: 24, class: "mr2" %>
        This transaction has no receipt
      </p>
    <% else %>
      <p class="card__banner bg-pending slate bold flex items-center mt0 mb0">
        <%= inline_icon "important", size: 24, class: "mr2" %>
        This transaction is missing a receipt
      </p>
    <% end %>

  </article>
  <%= render partial: "hcb_codes/dispute", locals: { type: 'card', hcb_code: @hcb_code } %>
</div>

<% if organizer_signed_in? %>
<section class="modal modal--scroll bg-snow" data-behavior="modal" role="dialog" id="merchant_details">
  <%= modal_header 'Merchant details' %>
  <%@merchant_data = @hcb_code.pt.raw_pending_stripe_transaction.stripe_transaction["merchant_data"] %>

  <div class="details mb2">
    <p>
      <strong>Name</strong>
      <span>
        <%= @merchant_data["name"].humanize.capitalize %>
      </span>
    </p>
    <p>
      <strong>Category</strong>
      <span>
        <%= @merchant_data["category"].humanize.capitalize %>
      </span>
    </p>
    <p>
      <strong>Currency</strong>
      <span>
      <%= @hcb_code.pt.raw_pending_stripe_transaction.stripe_transaction["merchant_currency"].upcase %>
      </span>
    </p>
    <% if is_city_or_phone?(@merchant_data["city"]) == :phone %>
      <p>
        <strong>Phone</strong>
        <span><%= (@merchant_data["city"]) %></span>
      </p>
    <% elsif is_city_or_phone?(@merchant_data["city"]) == :city %>
      <p>
        <strong>City</strong>
        <span><%= (@merchant_data["city"]).humanize %></span>
      </p>
    <% end %>
    <p>
      <strong>Zip</strong>
      <span><%= (@merchant_data["postal_code"] or "Unknown") %></span>
    </p>
    <p>
      <strong>State</strong>
      <span><%= (@merchant_data["state"]&.upcase or "Unknown") %></span>
    </p>
    <p>
      <strong>Country</strong>
      <span><%= country_to_emoji @merchant_data["country"] %></span>
    </p>
  </div>
  <article class="card__banner secondary border-top" style="margin: -2em; margin-top: 0;">
    <p class="my0 muted">
      Details are provided by the merchant and not guaranteed to be correct.
    </p>
  </article>
</section>
<% end %>

<% if organizer_signed_in? %>
<section class="modal modal--scroll bg-snow" data-behavior="modal" role="dialog" id="verification_details">
  <%= modal_header 'Charge details' %>
  <%@verification_data = @hcb_code.pt.raw_pending_stripe_transaction.stripe_transaction["verification_data"] %>

  <article class="details-horiz">
    <div class="mt1 md-mt0" style="width: 100%;">
      <p class="details__simulated">
        <strong>Payment type</strong>
        <span class="pl1">
        <%= @hcb_code.pt.raw_pending_stripe_transaction.stripe_transaction["authorization_method"].humanize.capitalize %></span>
        </span>
      </p>
      <p class="details__simulated">
        <strong><%= country_to_emoji @merchant_data["country"] %></strong>
        <span>Payment country</span>
      </p>
      <p class="details__simulated">
        <%= stripe_verification_check_badge 'address_line1' %>
        <span>Address check</span>
      </p>
    </div>
    <div class="mt1 md-mt0" style="width: 100%;">
      <p class="details__simulated">
        <%= stripe_verification_check_badge 'expiry' %>
        <span>Expiration check</span>
      </p>
      <p class="details__simulated">
        <%= stripe_verification_check_badge 'cvc' %>
        <span>CVC check</span>
      </p>
      <p class="details__simulated">
        <%= stripe_verification_check_badge 'address_postal_code' %>
        <span>Zip check</span>
      </p>
    </div>
  </article>
</section>
<% end %>