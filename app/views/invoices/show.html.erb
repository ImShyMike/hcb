<% title "Invoice to #{@invoice.sponsor.name} for #{render_money @invoice.total}" %>
<% page_md %>
<%= render 'events/nav' %>

<% qa = 3 %>

<%= creator_bar @invoice %>

<article class="card pb0">
  <h2 class="h2 sans mt0 border-none">
    <%= @sponsor.name %>
    <span class="regular muted"> invoiced for </span>
    <span class="regular"><%= render_money @invoice.item_amount %></span>
    <span class="badge h4 md-right bg-<%= @invoice.state %>">
      <%= @invoice.state_text %>
      <% if @invoice.state_icon %>
        <%= inline_icon @invoice.state_icon, size: 16 %>
      <% end %>
    </span>
  </h2>

  <section class="card__banner details-horiz bg-snow border-top border-bottom">
    <p>
      <% if invoice_paid_at %>
        <strong>Paid at</strong>
        <%= invoice_paid_at %>
      <% else %>
        <strong>Due</strong>
        <%= format_date @invoice.due_date.to_date %>
      <% end %>
    </p>

    <p>
      <strong>Payment method</strong>
      <span class="inline">
        <span>Visa<%# invoice.payment_method_card_brand.humanize.capitalize %></span>
        <span class="ml0 mr1"><%= inline_icon 'card', size: 16, class: 'accent inline' %></span>
        <span>••••1759<%# invoice.payment_method_card_last4 %></span>
      </span>
    </p>
    <!--
    <% if invoice_payment_method %>
    <p>
      <strong>Payment method</strong>
      <%= invoice_payment_method %>
    </p>
    <% end %>
    -->

    <p>
      <strong>Recipient email</strong>
      <%= mail_to @sponsor.contact_email, @sponsor.contact_email.downcase, class: 'black underline' %>
    </p>
  </section>
  
  <section class="details details--wide mt2 mb1">
    <% if @invoice.state == :success %>
    <p>
      <strong>Sponsor paid</strong>
      <span>
      <%= render_money @invoice.item_amount %>
      <% if @invoice&.payout %>
        via <%= @invoice.payout.source_type.humanize.downcase %>
        <% if @invoice&.payout&.created_at %>
          <span class="muted">(on <%= format_date @invoice.payout.created_at.to_date %>)</span>
        <% end %>
      <% end %>
      </span>
    </p>
    <% else %>
    <p>
      <strong>Invoice amount</strong>
      <span>
      <%= render_money @invoice.item_amount %>
      </span>
    </p>
    <% end %>

    <% unless @invoice.manually_marked_as_paid? %>
      <p>
      <% if @payout_t && @refund_t %>
        <strong>Funds available since</strong>
        <%= format_date [@payout_t.created_at, @refund_t.created_at].max %>
      <% elsif @payout_t && !@refund %>
        <strong>Funds available since</strong>
        <%= format_date @payout_t.created_at %>
      <% elsif @invoice.payout_creation_queued_at && @invoice.payout.nil? %>
        <strong>Payout of funds queued for</strong>
        <%= format_date @invoice.payout_creation_queued_for.to_date %>
      <% elsif @invoice.payout_creation_queued_at && @invoice.payout.present? %>
        <strong>Funds should be available</strong>
        <%= format_date @invoice.payout.arrival_date.to_date %></p>
      <% end %>
      </p>
    <% end %>
  </section>

  <% if @invoice.manually_marked_as_paid? %>
    <p>
      This invoice was manually marked as paid by <%= @invoice.manually_marked_as_paid_user.full_name %>.
      Reason given: "<%= @invoice.manually_marked_as_paid_reason %>"
    </p>
    <% if @invoice.manually_marked_as_paid_attachment.attached? %>
      <p><%= link_to 'Download provided attachment', @invoice.manually_marked_as_paid_attachment %></p>
    <% end %>
  <% end %>

  <section class="card__banner bg-snow border-top">
    <% if @invoice.hosted_invoice_url && @invoice.invoice_pdf %>
      <%= link_to 'View sent invoice', @invoice.hosted_invoice_url, class: 'btn bg-accent mr2', target: '_blank'  %>
      <%= link_to 'Download invoice PDF', @invoice.invoice_pdf, class: 'btn bg-info', target: '_blank'  %>
    <% end %>

    <% admin_tools('mt2') do %>
      <%= link_to 'Manually mark as paid', invoice_manual_payment_path(@invoice), class: 'btn bg-success mr2' unless @invoice.paid? %>
      <%= link_to 'View on Stripe', @invoice.stripe_dashboard_url, class: 'btn bg-accent' %>
    <% end %>
  </section>
</article>

<article class="card pb0 mt3">
  <h2 class="h2 sans mt0 border-none">
    Payment details
    <span class="regular muted"> of </span>
    <span class="regular">Visa card</span>
  </h2>
  <section class="card__banner bg-snow border-top border-bottom">
  <table>
    <thead></thead>
    <tbody>
    <tr><td>Number</td><td>•••• 9071</td></tr>
    <tr><td>Expires</td><td>07 / 2022</td></tr>
    <tr><td>Type</td><td>Visa credit card</td></tr>
    <tr><td>Postal code</td><td>90069</td></tr>
    <tr><td>Origin</td><td>United States</td></tr>
    <tr><td>CVC check</td><td><span class="badge h4 medium bg-success ml0">Passed <%= inline_icon 'checkmark', size: 20 %></span></td></tr>
    <tr><td>Zip check</td><td><span class="badge h4 medium bg-success ml0">Passed <%= inline_icon 'checkmark', size: 20 %></span></td></tr>
    <tr class="border-none"><td>Address check</td><td><span class="badge h4 medium bg-success ml0">Passed <%= inline_icon 'checkmark', size: 20 %></span></td></tr>
    </tbody>
  </table>
  </section>
</article>

<% if qa == 1 %>
<article class="card pb0 mt3">
  <h2 class="h2 sans mt0 border-none">
    Transaction details
  </h2>
  <section class="card__banner details-horiz bg-snow border-top border-bottom">
    <p class="w-100 center">
      <strong>Amount</strong>
      <%= render_money @invoice.item_amount %>
    </p>
    <p class="w-100 center">
      <strong>
        Fee
        <span class="tooltipped tooltipped--e" aria-label="<%= invoice_hcb_percent %> Bank fee"><%= inline_icon 'info', size: 16 %></span>
      </strong>
      <%= invoice_hcb_revenue %>
    </p>
    <p class="w-100 center">
      <strong>Net</strong>
      <%= invoice_event_profit %>
    </p>
  </section>
  <section class="details details--wide mt2 mb1">
    <p>
      <strong>Display name</strong>
      <span>
        <%= @payout_t.display_name %> <%= link_to 'Edit', edit_transaction_path(@payout_t), class: 'underline inline ml2' %>
      </span>
    </p>
    <p>
      <strong>Statement name</strong>
      <span>
        <%= @payout_t.name %>
      </span>
    </p>
  </section>
</article>
<% end %>
<% if qa == 2 %>
<article class="card pb0 mt3">
  <h2 class="h2 sans mt0 border-none">
    Transaction details
  </h2>
  <section class="card__banner bg-snow border-top border-bottom">
  <table>
    <thead></thead>
    <tbody>
      <tr>
        <td class="muted no-wrap pr3">Display name</td>
        <td class="w-100" colspan="3"><%= @payout_t.display_name %> <%= link_to 'Edit', edit_transaction_path(@payout_t), class: 'underline inline ml2' %></td>
      </tr>
      <tr>
        <td class="muted no-wrap pr3">Statement name</td>
        <td class="w-100" colspan="3"><%= @payout_t.name %></td>
      </tr>
    </tbody>
  </table>
  <table>
    <thead>
    <tr class="right-align border-none">
      <td><!-- Spacer --></td>
      <td><!-- Spacer --></td>
      <td><!-- explaination --></td>
      <td class="muted">Change</td>
      <td>Balance</td>
    </tr>
    </thead>
    <tbody class="no-wrap">
      <%= render 'invoices/line_item', name: 'Paid', tip: nil, change: @invoice.item_amount, balance: @invoice.item_amount %>
      <%= render 'invoices/line_item', name: 'Fee', tip: 'Payment processor fees', change: -invoice_payment_processor_fee(false), balance: @invoice.item_amount - invoice_payment_processor_fee(false) %>
      <%= render 'invoices/line_item', name: 'Refund', tip: 'We cover the processor fee', change: invoice_payment_processor_fee(false), balance: @invoice.item_amount %>
      <%= render 'invoices/line_item', name: 'Bank', tip: "#{invoice_hcb_percent} Bank fee", change: -invoice_hcb_revenue(false), balance: invoice_event_profit(false) %>
      <tr class="right-align border-top">
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td>Total: <span class="bold"><%= render_money invoice_event_profit(false) %></span></td>
      </tr>
    </tbody>
  </table>
  </section>
</article>
<% end %>
<% if qa == 3 %>
<article class="card pb0 mt3">
  <h2 class="h2 sans mt0 border-none">
    Transaction details
  </h2>
  <section class="details details--wide bg-snow card__banner border-top">
  <table class="max-width-1">
    <thead>
    <tr class="right-align border-none">
      <td><!-- explaination --></td>
      <td class="muted">Change</td>
      <td>Balance</td>
    </tr>
    </thead>
    <tbody>
      <tr class="right-align border-none">
        <td class="left-align muted">Paid</td>
        <td class="muted">+<%= render_money @invoice.item_amount %></td>
        <td><%= render_money @invoice.item_amount %></td>
      </tr>
      <tr class="right-align border-none">
        <td class="left-align muted">Fee<span class="tooltipped tooltipped--e" aria-label="Payment processor fees"><%= inline_icon 'info', size: 16 %></span></td>
        <td class="muted">-<%= render_money invoice_payment_processor_fee(false), '' %></td>
        <td><%= render_money @invoice.item_amount - invoice_payment_processor_fee(false) %></td>
      </tr>
      <tr class="right-align border-none">
        <td class="left-align muted">Refund <span class="tooltipped tooltipped--e" aria-label="We cover the processor fee"><%= inline_icon 'info', size: 16 %></span></td>
        <td class="muted">+<%= render_money invoice_payment_processor_fee(false), '' %></td>
        <td><%= render_money @invoice.item_amount %></td>
      </tr>
      <tr class="right-align border-none">
        <td></td>
        <td></td>
        <td>Total: <span class="bold"><%= render_money @invoice.item_amount %></span></td>
      </tr>
    </tbody>
  </table>
  </section>
</article>
<% end %>

<h2>Notes</h2>
<%= render 'comments/comments' %>
<%= render 'comments/form' %>