<% transaction = invoice.payout.t_transaction %>
<% refund = invoice&.fee_reimbursement %>
<% refund_t = refund&.t_transaction %>
<% @invoice = invoice %>
<tr
  class="transaction--positive"
  data-behavior="filterbar_row parent_expandable_row"
  data-filter="<%= transaction.filter_data.to_json %>"
  data-id="<%= transaction.id %>"
  aria-expanded="false"
>
  <td>
    <%= transaction.date %>
  </td>
  <td>
    Invoice to <%= invoice.sponsor.name %> for <%= render_money invoice.item_amount %>
  </td>
  <td>
    <%= link_to 'See Invoice', invoice, class: 'underline' %>
  </td>
  <td class="<%= 'bold' if invoice.state_text == 'Paid' %>">
    <%= render_money transaction.amount + refund_t&.amount.to_i %>
  </td>
  <td>
    <% if refund %>
      <span class="underline pointer no-select" data-id="<%= transaction.id %>" data-expanded="false" data-behavior="row_expand_trigger">Expand</span>
    <% end %>
  </td>
  <td>
    <% unless refund %>
      <%= link_to 'Details', transaction, class: 'underline' %>
    <% end %>
  </td>
</tr>
<% if refund %>
<tr class="transaction--positive invoice--expanded"
data-behavior="expandable_row filterbar_row"
data-id="<%= transaction.id %>"
data-filter="<%= transaction.filter_data.to_json %>"
>
  <td class="transaction--nested">
    <%= transaction.date %>
  </td>
  <td colspan="2" class="transaction--nested">
    <%= transaction.display_name %>
  </td>
  <td colspan="2">
    <%= render_money transaction.amount %>
  </td>
  <td></td>
</tr>
<tr class="transaction--positive invoice--expanded<%= ' muted italic' unless refund_t %>"
data-behavior="expandable_row filterbar_row"
data-id="<%= transaction.id %>"
data-filter="<%= transaction.filter_data.to_json %>"
>
  <td class="transaction--nested">
    <%= refund_t ? refund_t.date : '(pending)' %>
  </td>
  <td colspan="2" class="transaction--nested">
    <%= refund_t ? refund_t.display_name : 'Payment processor fee refund' %>
  </td>
  <td colspan="2">
    <%= invoice_payment_processor_fee %>
  </td>
  <td></td>
</tr>
<% end %>
