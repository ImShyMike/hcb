<% title "Your reimbursements" %>
<% page_md %>
<%= render "users/nav", selected: :reimbursements %>

<h1 class="heading">
  <span>
    Reimbursements
  </span>

  <% if @payout_method.present? %>
    <%= link_to settings_payouts_path, class: "btn bg-info" do %>
      <%= inline_icon @payout_method.icon %>
      Payout settings
    <% end %>
  <% else %>
    <%= link_to settings_payouts_path, class: "btn bg-warning" do %>
      <%= inline_icon "payment-docs" %>
      Configure payouts
    <% end %>
  <% end %>

  <% if current_user.events.not_demo_mode.any? %>
    <%= link_to "#", class: "btn bg-success", data: { behavior: "modal_trigger", modal: "create" } do %>
      <%= inline_icon "plus" %>
      New
    <% end %>
  <% end %>
</h1>

<%= render partial: "reimbursement/reports/create_form" %>

<section class="grid grid--split grid--spacious mb2">
  <div>
    <label for="sms_number">Start a report via SMS</label>
    <p class="h5 muted mt0 mb1">
      Message photos from your phone.
    </p>
    <div class="relative block" data-controller="clipboard" data-clipboard-text-value="+1-864-548-4225">
      <input id="sms_number" type="tel" value="+1-864-548-4225" readonly style="cursor: text;" class="fit">
      <button
        type="button"
        class="pointer pop mr2 align-middle tooltipped tooltipped--n"
        style="position: absolute; top: 50%; right: -8px; transform: translateY(-50%) scale(0.9);"
        aria-label="Copy number"
        data-action="clipboard#copy:prevent">
        <%= inline_icon "copy", size: 28 %>
      </button>
    </div>
  </div>

  <div>
    <label for="email_address">Start a report via email</label>
    <p class="h5 muted mt0 mb1">
      Send from in-store terminals, or forward emails later.
    </p>
    <div class="relative block" data-controller="clipboard" data-clipboard-text-value="reimburse@hcb.gg">
      <input id="email_address" type="email" value="reimburse@hcb.gg" readonly style="cursor: text;" class="fit">
      <button
        type="button"
        class="pointer pop mr2 align-middle tooltipped tooltipped--n"
        style="position: absolute; top: 50%; right: -8px; transform: translateY(-50%) scale(0.9);"
        aria-label="Copy email address"
        data-action="clipboard#copy:prevent">
        <%= inline_icon "copy", size: 28 %>
      </button>
    </div>
  </div>
</section>

<%= form_with(model: nil, local: true, method: :get) do |form| %>
  <div class="filterbar flex items-center width-100">
    <%= form.text_field :q, placeholder: "Searchâ€¦", class: "flex-auto md-mr2", style: "width auto; max-width: none;", value: params[:q] %>
    <%= link_to "?filter=my", class: "filterbar__item", "aria-selected": params[:filter] != "review_requested", role: "tab" do %>
      My reports
      <% unless current_user.reimbursement_reports.draft.none? %>
        <span class="m0 badge <%= params[:filter] == "review_requested" ? "bg-primary" : "bg-snow text-black" %>" style="margin-left: 2px; transform: translateY(-1px)">
          <%= current_user.reimbursement_reports.draft.count %>
        </span>
      <% end %>
    <% end %>
    <%= link_to "?filter=review_requested", class: "filterbar__item", "aria-selected": params[:filter] == "review_requested", role: "tab" do %>
      Review requested
      <% review_requested = Reimbursement::Report.submitted.where(event: current_user.events, reviewer_id: nil).or(current_user.assigned_reimbursement_reports.submitted) %>
      <% unless review_requested.none? %>
        <span class="m0 badge <%= params[:filter] != "review_requested" ? "bg-primary" : "bg-snow text-black" %>" style="margin-left: 2px; transform: translateY(-1px)">
          <%= review_requested.count %>
        </span>
      <% end %>
    <% end %>
  </div>
<% end %>

<% if @reports.blank? %>
  <%= blankslate "No reports found!" %>
<% else %>
  <article class="table-container">
    <table>
      <thead>
      <tr>
        <th>Status</th>
        <th>Report</th>
        <th>Organization</th>
        <th>Amount</th>
        <th>Created</th>
      </tr>
      </thead>
      <tbody>
        <% @reports.order(created_at: :desc).each do |report| %>
          <tr>
            <td>
              <% if report.status_description %>
                <span class="ml0 badge bg-<%= report.status_color %> tooltipped tooltipped--e tooltipped--xl" aria-label="<%= report.status_description %>">
                  <%= report.status_text %>
                </span>
              <% else %>
                <span class="ml0 badge bg-<%= report.status_color %>"><%= report.status_text %></span>
              <% end %>
            </td>
            <td style="max-width: 350px; overflow: hidden; text-overflow: ellipsis;">
              <%= link_to report.name, report %>
            </td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
               <%= report.event&.name || "None" %>
            </td>
            <td>
               <%= render_money report.amount_cents %>
            </td>
            <td>
               <%= format_date report.created_at %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </article>
<% end %>
