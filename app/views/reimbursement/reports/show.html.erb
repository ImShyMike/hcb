<% title @report.name %>
<% page_md %>
<%= render "events/nav", selected: :reimbursements %>

<style>
  html { scroll-behavior: smooth; }
</style>

<div class="mt4">
    <h3 class="mt2 mb1 muted flex" style="font-weight: 400; gap: 4px;">
      <span style="flex-grow: 1;">
        <%= user_mention @user, class: "tooltipped--s align-top" %>is requesting <%= render "total", report: @report %> for
      </span>
      <span class="ml0 badge bg-<%= @report.aasm_state %>"><%= @report.status_text %></span>
      <%= link_to "#", class: "ml0 badge bg-info text-decoration-none", data: { behavior: "modal_trigger", modal: "edit" } do %>
        Edit Details
      <% end %>
    </h3>
    <h2 class="heading mt0 mb1 flex">
      <span style="flex-grow: 1;"><%= @report.name %></span>
    </h2>
</div>

<section data-behavior="modal" role="dialog" id="edit" class="modal modal--scroll bg-snow">
  <%= modal_header "Edit Report" %>
  <%= render "edit_form" %>
</section>

<section class="flex items-start justify-center mt2 mb2" style="gap: 16px; position: relative;">
  <article class="card">
    <p class="mt0">
      HCB is able to reimburse you through either an ACH transfer or a check. To receive reimbursement, you'll need to submit each of your expenses to us through this report.
    </p>
    <p>
      Begin by adding an expense to this report below; for each expense, you'll need to attach
      a receipt, provide a memo describing the expense, and specify the amount you are seeking reimbursement for.
    </p>
    <p>
      Once you've added all of your expenses to the report, click <i>Submit</i> to begin the review process.
    </p>

    <section class="card__banner card__banner--bottom card__darker pt2 pb2">
      <p class="muted mt0 mb0">
        There are some restrictions and limitations on what transactions can be reimbursed. Learn more in our <a href="#">FAQ</a>.
      </p>
    </section>
  </article>
</section>

<h2 class="flex items-center">
  <span style="flex-grow: 1">Expenses</span>
</h2>

<div id="expenses">
  <% @report.expenses.order(created_at: :desc).each do |expense| %>
    <%= render "reimbursement/expenses/expense", expense: %>
  <% end %>
</div>

<div class="flex items-center justify-between mt2 mb3" style="gap: 16px;">
  <div style="flex-grow: 1;" class="flex justify-start">
    <div <%= 'class="tooltipped tooltipped--n" aria-label="Expenses can\'t be added to locked reports"'.html_safe if @report.locked? %>>
      <%= link_to reimbursement_expenses_path(report_id: @report.id), class: "btn bg-success #{@report.locked? ? "disabled" : ""}", style: (@report.locked? ? "opacity: 0.75" : ""), data: {
            turbo: true,
            turbo_method: :post
          } do %>
        <%= inline_icon "docs" %>
        Add An Expense
      <% end %>
    </div>
  </div>

  <div style="flex-grow: 1;" class="flex justify-center items-center" style="gap: 4px;">
    <% if !@report.event.users.include?(current_user) && @report.locked? %>
      <%= inline_icon "private" %>
      Expense Report Locked
    <% elsif @report.locked? && @report.submitted? %>
      <%= link_to reimbursement_report_request_reimbursement_path(report_id: @report.id), class: "btn bg-info", method: :post do %>
        <%= inline_icon "payment-transfer" %>
        Request Reimbusement (<%= @report.expenses.approved.count %>/<%= @report.expenses.count %>)
      <% end %>
    <% end %>
  </div>

  <div style="flex-grow: 1;" class="flex justify-end">
    <% can_be_marked_draft = !@report.locked? || !(@report.reimbursement_requested? || @report.reimbursement_approved?) %>
    <div <%= 'class="tooltipped tooltipped--n" aria-label="Locked reports can\'t be modified"'.html_safe if !can_be_marked_draft %>>
      <% if @report.draft? %>
        <%= link_to reimbursement_report_submit_path(report_id: @report.id), class: "btn bg-info", method: :post do %>
          <%= inline_icon "send" %>
          Submit & Request Review
        <% end %>
      <% else %>
        <%= link_to reimbursement_report_draft_path(report_id: @report.id), class: "btn bg-muted #{!can_be_marked_draft ? "disabled" : ""}", style: (!can_be_marked_draft ? "opacity: 0.75" : ""), method: :post do %>
          <%= inline_icon "reply" %>
          Mark As Draft
        <% end %>
      <% end %>
    </div>
  </div>

</div>

<style>
  .linethingy:not(:last-child)::before {
    content: "";
    width: 2px;
    height: calc(100% - 18px);
    background-color: var(--palette-smoke);
    display: block;
    position: absolute;
    top: 39px;
    left: 17.5px;
    z-index: 1;
    border-radius: 1px;
  }
  div.linethingy:not(:last-child)::before {
    height: calc(100% - 26px);
  }
  .linethingy, div.linethingy > * {
    position: relative;
    position: relative;
    z-index: 2;
  }
</style>

<h2 class="flex items-center">
  <span style="flex-grow: 1">Conversation</span>
</h2>
<article>
  <%= turbo_frame_tag :audit_log do %>
    <ul class="list-reset">
      <% versions = @report.versions.select { |version| version.changeset.any? { |field, changes| changes.any?(&:present?) } } %>
      <% comments = @report.comments %>
      <% (versions + comments).sort_by(&:created_at).each do |item| %>
        <% if item.instance_of?(Comment) %>
          <div class="linethingy">
            <% if item.admin_only %>
              <% admin_tools do %>
                <%= render "comments/item_v2", comment: item %>
              <% end %>
            <% else %>
              <%= render "comments/item_v2", comment: item %>
            <% end %>
          </div>
        <% else %>
          <% state_change = item.changeset["aasm_state"]&.second %>

          <li class="linethingy mt2" style="margin-bottom: 24px;">
            <% if state_change %>

              <% icon, color = {
                   "submitted"          => ["send", "info"],
                   "rejected"           => ["thumbsdown", "error"],
                   "reimbursement_requested" => ["thumbsup", "success"],
                   "reimbursement_approved"     => ["admin", "warning"],
                   "draft"              => ["docs", "muted"],
                   "reimbursed"         => ["docs", "purple"],
                 }[state_change] %>
              <div class="flex flex-row items-center" style="gap: 16px">
                <div class="flex items-center justify-center z2 pop no_hover bg-<%= color %>-important" style="color: white;">
                  <%= inline_icon icon, width: 30 %>
                </div>

                <div style="display: flex; align-items: center; gap: 4px">
                  <span class="muted" style="margin-right: -0.25em;">
                    <%= user_mention User.find_by(id: item.whodunnit), { img_style: "vertical-align: sub;" }, "Unknown User" %>
                  </span>
                  <span class="align-middle">
                    <%= {
                          "submitted"          => "submitted this report", # TODO: support submitted / resubmitted
                          "rejected"           => "rejected this report",
                          "reimbursement_requested" => "approved this report as an organizer",
                          "reimbursement_approved"     => "approved this report as an admin",
                          "draft"              => "converted this report to a draft",
                          "reimbursed"         => "initiated a reimbursement"
                        }[state_change] %>
                  </span>
                  <span class="tooltipped tooltipped--n align-middle" style="cursor: default" aria-label="<%= item.created_at.strftime("%b %e, %Y") %>">
                    <%= time_ago_in_words item.created_at %> ago
                  </span>
                </div>
              </div>
            <% else %>

              <div class="flex flex-row items-center" style="gap: 16px">
                <div class="pop bg-smoke-important no_hover relative z2">
                  <%= inline_icon "post", width: 30 %>
                </div>
                <div style="display: flex; align-items: center; gap: 4px">
                  <span class="muted; margin-right: -0.25em;">
                    <%= user_mention User.find_by(id: item.whodunnit), { hide_avatar: true }, "Unknown User" %>
                  </span>
                  <span class="align-middle"><%= item.event %>d this report</span>
                  <span class="tooltipped tooltipped--n align-middle" style="cursor: default" aria-label="<%= item.created_at.strftime("%b %e, %Y") %>">
                  <%= time_ago_in_words item.created_at %> ago</span>
                </div>
              </div>

              <% if item.event == "update" %>
                <ul class="list-reset" style="margin-left: 52px;">
                  <% item.changeset.excluding("updated_at").select { |field, changes| changes.any?(&:present?) }.each do |field, changes| %>
                    <li>
                      <strong class="muted"><%= field.humanize %>:</strong> <%= render_audit_log_value(field, changes[0], color: "primary") %> â†’ <%= render_audit_log_value(field, changes[1], color: "success") %>
                    </li>
                  <% end %>
                </ul>
              <% end %>
            <% end %>
          </li>
        <% end %>
      <% end %>
    </ul>
  <% end %>

  <div style="margin-top: 24px;"></div>
  <%= render "comments/form" %>
</article>
