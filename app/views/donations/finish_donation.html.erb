<% content_for :body_attributes do %>
  data-turbolinks="false"
<% end %>

<% content_for :head do %>
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    function flashError(message) {
      const flash = document.createElement('p')
      flash.classList.add('flash')
      flash.classList.add('error')
      flash.classList.add('fit')
      flash.textContent = `We couldn't process your donation. ${message}`

      document.querySelector('.processing-errors').appendChild(flash)
    }

    function resetErrors() {
      document.querySelector('.processing-errors').innerHTML = ''
    }
  </script>
  <script defer>
    document.addEventListener('turbolinks:load', function() {
      const stripe = Stripe('<%= StripeService.publishable_key %>')
      const elements = stripe.elements()
      const clientSecret = '<%= @donation.stripe_client_secret %>'

      const style = { base: { color: 'gray' } }

      var card = elements.create("card", { style: style })
      card.mount("#card-element")

      card.addEventListener('change', function(event) {
        var displayError = document.getElementById('card-errors')
        if (event.error) {
          displayError.textContent = event.error.message
        } else {
          displayError.textContent = ''
        }
      })

      var submitButton = document.getElementById('submit')

      submitButton.addEventListener('click', function(ev) {
        $('.show-on-processing').show()
        stripe.confirmCardPayment(clientSecret, {
          payment_method: {card: card}
        }).then(function(result) {
          if (result.error) {
            resetErrors()
            flashError(result.error.message)
          } else {
            // The payment has been processed!
            if (result.paymentIntent.status === 'succeeded') {
              $('.hide-on-success').hide()
              $('.show-on-processing').hide()
              $('.show-on-success').show()
            }
          }
        })
      })
    })
  </script>
<% end %>

<% title 'Give to ' + @event.name %>
<% page_sm %>
<% no_app_shell %>

<a href="<%= start_donation_donations_path(@event.slug) %>" class="black text-decoration-none">
  <h1 class="mt4 mb2 border-none center">
    <span class="h3 caps secondary block">Donate to</span>
    <span class=""><%= @event.name %></span>
  </h1>
</a>

<div class="card mb3">
  <p class="mt1">
    Hi <strong><%= @donation.name %></strong>,
  </p>

  <p class="mb2">
    Please enter your payment information for your contribution of
    <strong><%= render_money @donation.amount %></strong>.
  </p>

  <div class="hide-on-success">
    <label for="card-element" class="mb1">Payment information</label>
    <div class="stripe">
      <div id="card-element" class="donation--payment-info fit w-100">
        <!-- Stripe Elements will create input elements here -->
      </div>
      <div id="card-errors" role="alert" class="muted"></div>

      <div class="show-on-processing" style="display: none">
        <p class="flash fit">Sending your donation...</p>
      </div>

      <div class="processing-errors">
        <!-- Stripe errors will be flashed here -->
      </div>

      <div class="mt3">
        <button id="submit" class="btn w-100 donation-btn">Donate <%= render_money @donation.amount %></button>
      </div>
    </div>
  </div>

  <div id="success" class="show-on-success center mt3" style="display: none">
    <p class="flash success fit">
      Thanks! Your generous donation to <%= @event.name %>
      is on its way. We'll send you a receipt shortly.
    </p>
  </div>
</div>

<%= render 'footer' %>
