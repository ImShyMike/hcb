<% title "Enter login code" %>
<% page_xs %>
<% @home_size = 128 %>
<% content_for(:page_class) { "bg-snow pt4" } %>

<article class="center mt3">
  <h1 class="mt2">
    <span class="h3 caps secondary block">Sign in to HCB</span>
    <span class="black">Login Code</span>
  </h1>
  <p>We just sent a login code to <%= @use_sms_auth ? "your phone number ending in: " + @phone_last_four : @email %></p>
  <% if Rails.env.development? %>
    <p class="h5"><%= link_to "Seems like you're in development. Check your dev email outbox here!", letter_opener_web_path, target: :_blank %></p>
  <% end %>
   <%= form_tag exchange_login_code_users_path do %>
    <%= label_tag :login_code, "Enter your login code", class: "left-align" %>
    <%= telephone_field_tag :login_code, "", placeholder: "Login code", autofocus: true, autocomplete: "off", class: "left-align mb2", required: true %>
    <%= hidden_field_tag :email, @email %>
    <%= hidden_field_tag :user_id, @user_id %>
    <%= hidden_field_tag :fingerprint %>
    <%= hidden_field_tag :device_info %>
    <%= hidden_field_tag :os_info %>
    <%= hidden_field_tag :timezone %>

    <%= hidden_field_tag :return_to, @return_to if @return_to %>
    <% if @force_use_email %>
      <%= hidden_field_tag :force_use_email, true %>
    <% end %>
    <% if @use_sms_auth %>
      <%= hidden_field_tag :sms %>
    <% else %>
      <p class="h5 muted"><em>Make sure to check your spam folder</em></p>
    <% end %>
    <%= submit_tag "Submit" %>
  <% end %>
  <% if @use_sms_auth %>
    <p>Don't have access to your phone?
      Click
      <%= link_to "here", login_code_users_path, data: { behavior: "submit_form", form: "use_email_form" } %>
      to send a login code to your
      email instead</p>

    <%= form_with id: "use_email_form", url: login_code_users_path, class: "display-none" do |form| %>
      <%= form.hidden_field :force_use_email, value: true %>
      <%= form.hidden_field :email, value: @email %>
    <% end %>
  <% end %>

  <% if @webauthn_available %>
    <%= link_to "Sign in another way", choose_login_preference_users_path, class: "block mt2" %>
  <% end %>
</article>
<%= javascript_include_tag "fingerprint.js" %>
