<% title "Card #{@card.last_four}" %>
<%= render 'events/nav' %>

<% admin_tools('mt3') do %>
  <%= link_to 'View on Stripe', @card.stripe_dashboard_url, class: 'btn bg-accent' %>
<% end %>

<% if @card.canceled? %>
  <div class="card border b--info mt3 mb3 container--sm mx-auto">
    <div class="flex items-center info">
      <%= inline_icon 'info', size: 32, class: 'mr1' %>
      <p class="bold mt0 mb0">This card has been canceled.</p>
    </div>
    <% if @card.replacement %>
      <p class="mt1 mb0">
        It was replaced by <%= stripe_card_mention @card.replacement %>.
      </p>
    <% end %>
  </div>
<% end %>

<article class="check--form flex items-start justify-center mt2 mb3">
  <section class="center mt0 mx-auto" style="width: 400px; max-width: 100%;">
    <%= render @card %>
    <% if !@card.activated? %>
      <% if @card.replacement_for %>
        <div class="card border b--warning pb0 mt3 mx-auto" data-controller="form-disable">
          <div class="flex items-center warning">
            <%= inline_icon 'info', size: 32, class: 'mr1' %>
            <p class="bold mt0 mb0">Heads up:</p>
          </div>
          <p class="mt1 left-align">
            Since this card is a replacement, activating it will permanently deactivate <%= stripe_card_mention @card.replacement_for %>.
          </p>
          <p class="mt1 left-align">
            You'll need to update billing information for any subscriptions that use <%= stripe_card_mention @card.replacement_for %>.
          </p>
          <div class="field field--checkbox">
            <input type="checkbox" id="confirm" data-action="form-disable#run" data-form-disable-target="radioButton" />
            <label for="confirm">Click here to confirm.</label>
          </div>
          <%= button_to stripe_card_activate_path(@card),
                      method: :post,
                      class: 'btn bg-success mt1 mb2', data: { "form-disable-target" => "submitButton" } do %>
            <%= inline_icon 'rep', size: home_action_size %>
            Activate card
          <% end %>
        </div>
      <% else %>
        <%= button_to stripe_card_activate_path(@card),
                    method: :post,
                    class: 'btn bg-success mt3' do %>
          <%= inline_icon 'rep', size: home_action_size %>
          Activate card
        <% end %>
      <% end %>
    <% elsif @card.stripe_status == 'inactive' %>
      <%= link_to 'Defrost card',
                  stripe_card_defrost_path(@card),
                  method: :post,
                  class: 'btn bg-accent mt3' %>
    <% elsif @card.stripe_status == 'active' %>
      <%= link_to stripe_card_freeze_path(@card),
                  method: :post,
                  class: 'btn bg-accent mt3' do %>
        <%= inline_icon 'freeze' %> Freeze card
      <%end%>
      <p class="muted">You can instantly defrost your card anytime</p>
    <% end %>
  </section>

  <% if @card.activated? %>
  <article class="card max-width-2 mx-auto mt3">
    <h2 class="mt0 heading">
      <span class="flex-auto">
        <%= @card.virtual? ? 'Virtual card' : 'Card' %>
        for <%= user_mention @card.user %>
      </span>
    </h2>

    <section class="details mt2">
      <% if @card.replacement_for %>
        <p>
          <strong>Replacement for</strong>
          <span class="flex items-baseline">
            <%= stripe_card_mention @card.replacement_for %>
          </span>
        </p>
      <% end %>

      <% eta = @card.stripe_obj.to_hash.dig(:shipping, :eta) %>
      <% if eta && Time.now.before?(Time.at(eta) + 3.days) %>
        <p>
          <strong>Expected arrival</strong>
          <%= format_date Time.at(eta).to_date %>
        </p>
      <% else %>
        <p>
          <strong>Activation status</strong>
          <span class="flex items-baseline">
            <%= status_badge @card.status_badge_type %>
            <%= @card.status_text.capitalize %>
          </span>
        </p>
      <% end %>

      <% if @card.virtual? %>
        <% if @card.user == current_user %>
          <div>
            <strong>
              Card number
            </strong>
            <%= @card.formatted_card_number %>
          </div>
        <% end %>

        <% if @card.user == current_user %>
        <div>
          <strong>CVC</strong>
          <%= @card.cvc %>
        </div>
        <% end %>

        <div>
          <strong>Expiration date</strong>
          <%= render_exp_date %>
        </div>

        <div>
          <strong>ZIP/Postal code</strong>
          <%= @card.stripe_cardholder.address_postal_code %>
        </div>
      <% else %>
        <div>
          <strong>
            Card number
          </strong>
          <%= @card.formatted_card_number %>
          <div class="right tooltipped tooltipped--w" aria-label="Full number hidden to protect security">
            <%= inline_icon 'private', size: 32, class: 'smoke' %>
          </div>
        </div>
      <% end %>

      <p>
        <strong>Billing address</strong>
        <%= render_address @card.cardholder %>
      </p>
    </section>
    <% admin_tools 'details' do %>
      <div>
        <strong>Ordered at</strong>
        <%= format_datetime Time.at(@card.stripe_obj[:created]) %>
      </div>
    <% end %>

    <section class="grid grid--split items-end pt2">
      <div class="stat tooltipped tooltipped--s" aria-label="This is your account balance">
        <strong class="stat__label">Spending limit</strong>
        <span class="stat__value">
          <%= render_money_amount @event.balance_v2_cents %>
        </span>
      </div>
      <div class="stat stat--small">
        <strong class="stat__label">Lifetime spent</strong>
        <span class="stat__value">
          <%= render_money_amount @card.total_spent %>
        </span>
      </div>
    </section>

    <section class="card__banner card__banner--bottom card__darker pt2 pb2">
      <p class="muted mt0 mb0">
      Alert us if there are fraudulent or incorrect charges on your card. <%= help_message %>
      </p>
    </section>
  </article>
  <% end %>
</article>

<% if @hcb_codes.exists? %>
  <h2 class="heading h2 line-height-4 mt0 ml0 pt1 pb1 pl2 pr2">Transactions on this card</h2>

  <div class="table-container">
    <table>
      <tbody data-behavior="transactions">
        <% @hcb_codes.order(created_at: :desc).each do |hcb_code| %>
          <% if hcb_code.canonical_transactions.any? %>
            <% hcb_code.canonical_transactions.each do |ct| %>
              <%= render partial: "canonical_transactions/canonical_transaction", locals: { ct: hcb_code } %>
            <% end %>
          <% else %>
            <% hcb_code.canonical_pending_transactions.each do |pt| %>
              <%= render partial: "canonical_pending_transactions/canonical_pending_transaction", locals: { pt: pt, force_display_details: true  } %>
            <% end %>
          <% end %>
        <% end %>
      </tbody>
    </table>
    <%= paginate @hcb_codes %>
  </div>

  <%#= render 'stripe_authorizations/list', stripe_authorizations: @authorizations, headless: true, authorless: true %>
<% elsif @card.activated? %>
  <%= blankslate "No transactions made on this card yet." %>
<% end %>
