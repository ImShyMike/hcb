<% title "Transfers for #{@event.name}" %>
<% page_md %>
<%= render "events/nav" %>

<h1 class="heading">
  <span class="flex items-center">
    Transfers
    <%= badge_for @transfers.count, class: "bg-muted" %>
  </span>

  <% if organizer_signed_in? %>
    <% if @event.beta_features_enabled? %>
      <%= link_to "New transfer", new_disbursement_path(source_event_id: @event), class: "btn bg-success" %>
    <% end %>
    <%= link_to "Reimbursement", event_reimbursements_path(@event), class: "btn" %>
    <action type="button" class="btn bg-accent overflow-visible menu__toggle" data-behavior="menu_toggle" aria-expanded="false" tabindex="0">
      Send
      <div class="menu__content" data-behavior="menu_content">
        <%= link_to "ACH", new_event_ach_transfer_path(@event) %>
        <%= link_to "Check", new_event_check_path(@event) %>
        <%= link_to paypal_transfers_airtable_form_url(embed: false, event: @event, user: @current_user),
          data: { behavior: "modal_trigger", modal: "paypal_transfer" } do %>
          PayPal
        <% end %>
        <%= link_to "Transfer", new_disbursement_path(source_event_id: @event) if @event.beta_features_enabled? %>
      </div>
    </action>

    <!-- Modal for PayPal transfers -->
    <section class="modal" data-behavior="modal" role="dialog" id="paypal_transfer">
      <%= modal_header "PayPal transfer" %>
      <p class="mt0">PayPal may charge <%= link_to 'fees', 'https://www.paypal.com/us/webapps/mpp/paypal-fees', target: 'blank' %>
        (eg. currency conversion) for transfers. These fees will be passed down to you. Need help? <%= help_message %>.
      </p>
      <iframe src='<%= paypal_transfers_airtable_form_url(embed: true, event: @event, user: @current_user) %>' style='border:none;' name='donateFrame' scrolling='yes' frameborder='0' marginheight='0px' marginwidth='0px' height='256px' width='512px' allowfullscreen style="width: 100%; max-width: 100%; max-height: 40vh;"></iframe>
      <%= link_to "open in a new tab", paypal_transfers_airtable_form_url(embed: false, event: @event, user: @current_user), target: "_blank" %>
    </section>
  <% end %>
</h1>

<div class="statset mt3 mb2">
  <div class="stat stat--small">
    <span class="stat__label">Total</span>
    <span class="stat__value"><%= render_money_amount @stats[:deposited] %></span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">On the way</span>
    <span class="stat__value"><%= render_money_amount @stats[:in_transit] %></span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">Canceled</span>
    <span class="stat__value"><%= render_money_amount @stats[:canceled] %></span>
  </div>
</div>

<hr/>

<div style="text-align: center;">
  <%= link_to "All", "?filter=all", class: "filterbar__item", "aria-selected": !["deposited", "in_transit", "canceled"].include?(params[:filter]), role: "tab" %>
  <%= link_to "Deposited", "?filter=deposited", class: "filterbar__item", "aria-selected": params[:filter] == "deposited", role: "tab" %>
  <%= link_to "In Transit", "?filter=in_transit", class: "filterbar__item", "aria-selected": params[:filter] == "in_transit", role: "tab" %>
  <%= link_to "Canceled", "?filter=canceled", class: "filterbar__item", "aria-selected": params[:filter] == "canceled", role: "tab" %>
</div>

<%= form_with(model: nil, local: true, method: :get) do |form| %>
  <div class="filterbar flex flex-wrap items-center width-100">

    <%= form.text_field :q, placeholder: "Searchâ€¦", class: "flex-auto md-mr2", style: "width auto; max-width: none;", value: params[:q] %>

  </div>
<% end %>

<% if @transfers.size > 0 %>
<article class="table-container">

  <table>
    <thead>
      <tr>
        <th>TYPE</th>
        <th>STATUS</th>
        <th>DATE</th>
        <th>TO</th>
        <th style="text-align: right;">AMOUNT</th>
        <th></th>
      </tr>
    </thead>

    <tbody>
      <% @transfers.each do |d| %>
        <tr>
          <td>
            <%= d.is_a?(Check) ? "CHECK" : d.is_a?(AchTransfer) ? "ACH" : "TRANSFER" %>
          </td>
          <td>
            <span class="ml0 badge bg-<%= d.state %>"><%= d.state_text.capitalize %></span>
          </td>
          <td>
            <%= format_date d.created_at %>
          </td>
          <td>
            <% if organizer_signed_in? %>
              <% if d.is_a?(Disbursement) %>
                <strong>
                  <% if d.destination_event.is_public? || organizer_signed_in?(d.destination_event) %>
                    <%= link_to d.destination_event.name, d.destination_event %>
                  <% else %>
                    <%= d.destination_event.name %>
                  <% end %>
                </strong>
                for
              <% end %>
              <%= d.name %>
            <% else %>
              <span class="muted">(Sign in to view)</span>
            <% end %>
          </td>
          <td style="text-align: right;">
            <%= render_money(d.amount) %>
          </td>
          <td>
            <%= link_to "Details", hcb_code_url(d.local_hcb_code.hashid) if organizer_signed_in? %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

</article>
<% else %>
  <%= blankslate 'No transfers yet' %>
<% end %>


