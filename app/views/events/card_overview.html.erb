<% page_md %>
<% page_snow %>
<%= render 'nav'%>

<h1>
  Debit Cards
</h1>

<article class="card">
  <h2 class="mt0 mb2">Summary</h2>
  <div class="stat inline-block mr2 mb2">
    <span class="stat__label">Available balance</span>
    <span class="stat__value"><%= render_money @event.emburse_balance, '' %></span>
  </div>

  <div class="flex flex-wrap items-center">
    <%= link_to 'Increase Balance', new_event_load_card_request_path(event_id: @event.slug), class: 'btn bg-success mr2' %>
    <span class="h5 mt1 mb1">
      (The average time of the last five transfers to Emburse is <strong> <%= pluralize LoadCardRequest.processing_time, 'day' %></strong>)
    </span>
  </div>

  <p class="slate measure h5 mb0">
    Transfers may take longer than the current average. Sadly
    this is beyond our control, constrained by the US banking /
    ACH transfer system. Please plan accordingly.
  </p>

  <% if @event.cards.any? %>
    <p class="stat__label mt2">Your billing address for purchases</p>
    <pre class="inline-block mt0 mb0">The Hack Foundation
8605 Santa Monica Blvd #86294
West Hollywood, CA 90069</pre>
  <% end %>

  <% admin_tools('flex items-center mt2') do %>
    <% if @event.emburse_department_path.nil? %>
      <%= link_to 'Set Emburse Department ID', edit_event_path(@event), class: 'btn bg-accent mr2' %>
    <% else %>
      <%= link_to 'Set Emburse Budget', @event.emburse_department_path, class: 'btn bg-accent mr2' %>
    <% end %>
    <span class="h5 mt1 mb1">
      (Current: <strong>$<%= render_money @event.emburse_budget_limit, '' %></strong>)
    </span>
  <% end %>
</article>

<h2 class="heading">
  Event Cards
  <%= link_to 'Request a Card',
    new_card_request_path(event_id: @event.id),
    class: 'btn bg-success' %>
</h2>
<% if @event.cards.any? %>
  <section class="emburse-cards mt2 md-mt3">
    <% @event.cards.each do |card| %>
      <%= link_to card do %>
        <div class="emburse-cards__card">
          <p class="emburse-cards__card__number">
            <span>XXXX-XXXX-XXXX-</span><strong><%= card.last_four %></strong>
          </p>
          <p class="emburse-cards__card__name"><%= card.full_name %></p>
        </div>
        <p class="emburse-cards__caption">(sent <span title="<%= card.created_at %>"><%= time_ago_in_words card.created_at %> ago</span>)</p>
      <% end %>
    <% end %>
  </section>
<% elsif @card_requests.any? %>
  <%= blankslate 'No cards have been accepted yet.' %>
<% end %>

<% if @card_requests.any? %>
  <h2 class="mb1">Card Requests</h2>
  <% @card_requests.each do |request| %>
    <%= creator_bar request %>
    <div class="card flex items-center pt0 pb0 mb3">
      <p class="line-height-3 flex-auto">
        <%= status_badge request.status_badge_type %>
        <strong class="h3"><%= request.full_name %></strong>
        <span class="muted">(<%= request.status %>)</span>
      </p>
      <%= pop_icon_to 'view-close',
        card_request_cancel_path(request),
        method: :post,
        title: 'Cancel this request',
        'data-confirm': 'Are you sure you want to cancel your card request?',
        class: 'error' if request.under_review? && (request.creator == current_user || admin_signed_in?) %>
    </div>
  <% end %>
<% elsif @cards.empty? %>
  <%= blankslate 'You haven’t requested any physical debit cards yet.' %>
<% end %>

<% if @emburse_transactions.any? and admin_signed_in? %>
  <h3 class="heading">
<% if @load_card_requests.any? %>
  <h2 class="heading">
    Emburse Balance Requests
    <%= link_to 'Request to Add Money',
      new_event_load_card_request_path(event_id: @event.id),
      class: 'btn bg-success' %>
  </h2>
  <% @load_card_requests.each do |request| %>
    <%= creator_bar request %>
    <div class="card flex items-center pt0 pb0 mb3">
      <p class="line-height-3 flex-auto">
        <%= status_badge request.status_badge_type %>
        <strong class="h3"><%= render_money request.load_amount %></strong>
        <span class="muted">(<%= request.status %>)</span>
      </p>
      <%= pop_icon_to 'view-close',
        load_card_request_cancel_path(request, event_id: request.event.id),
        method: :post,
        title: 'Cancel this request',
        'data-confirm': 'Are you sure you want to cancel this balance request?',
        class: 'error' if request.under_review? && (request.creator == current_user || admin_signed_in?) %>
    </div>
  <% end %>
<% end %>
    Emburse Transactions
  </h3>
  <ul class="list list--row">
    <% @emburse_transactions.order(transaction_time: :desc).where.not(transaction_time: nil).each do |transaction| %>
      <a href="<%= transaction.emburse_path %>" target="_blank">
        <li>
          <p class="flex-auto">
            <%= status_badge transaction.status_badge_type %>
            <strong><%= render_money transaction.amount %> <%= transaction.merchant_name %> <%= '– ' + transaction.card.full_name if transaction.card %> – <%= transaction.state %></strong>
            <span class="muted">(created on <%= transaction.transaction_time.to_date %>)</span>
          </p>
        </li>
      </a>
    <% end %>
  </ul>
<% end %>
