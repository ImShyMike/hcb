<% title "Donations to #{@event.name}" %>
<% page_md %>
<%= render "events/nav", selected: :donations %>

<h1 class="heading">
  <span class="flex items-center">
    Donations
    <%= badge_for @donations.count, class: "bg-muted" %>
  </span>

  <% if @event.donation_page_enabled %>
    <%= link_to start_donation_donations_path(@event), target: "_blank", class: "btn" do %>
      <%= inline_icon "external" %>
      Donate page
    <% end %>

    <div class="md-pl1">
      <action type="button" class="pop menu__toggle" data-behavior="menu_toggle" aria-expanded="false" tabindex="0">
        <%= inline_icon "share" %>
        <div class="menu__content" data-behavior="menu_content">
          <%= link_to qr_code_donations_path(@event.slug),
            data: { behavior: "modal_trigger", modal: "qr_code" } do %>
            QR code
          <% end %>
          <%= link_to start_donation_donations_url(@event),
            data: { behavior: "modal_trigger", modal: "embed_code" } do %>
            Embed code
          <% end %>
          <%= link_to '#',
            data: { behavior: "modal_trigger", modal: "prefilled_link" } do %>
            Prefilled amount
          <% end %>
        </div>
      </action>
    </div>
  <% end %>
</h1>

<% if @event.donation_page_enabled %>
  <section class="modal" data-behavior="modal" role="dialog" id="qr_code">
    <%= modal_header "Donations QR code" %>
    <img alt="QR code" src="<%= qr_code_donations_path @event %>">
  </section>

  <section class="modal" data-behavior="modal" role="dialog" id="embed_code">
    <%= modal_header "Donations embed" %>
    <p class="mt0">Paste this HTML code into your website to embed your donation page. Feel free to change the styling.</p>
    <pre><%= html_escape "<iframe src='#{start_donation_donations_url @event}' style='border:none;' name='donateFrame' scrolling='yes' frameborder='0' marginheight='0px' marginwidth='0px' height='512px' width='512px' allowfullscreen></iframe>".gsub("'", '"') %></pre>
    <h3 class="mb0">Preview</h3>
    <iframe src='<%= start_donation_donations_url @event %>' style='border:none;' name='donateFrame' scrolling='yes' frameborder='0' marginheight='0px' marginwidth='0px' height='256px' width='512px' allowfullscreen style="width: 100%; max-width: 100%; max-height: 40vh;"></iframe>
  </section>

  <section class="modal" data-behavior="modal" role="dialog" id="prefilled_link">
    <%= modal_header "Prefilled Amount" %>
    <%= react_component 'donation_overview/PreviewLink', path: start_donation_donations_url(@event) %>
  </section>
<% else %>
  <p>You can start accepting donations once you enable it in your project's <%= link_to "settings", edit_event_path(@event, anchor: "donations") %>.</p>
<% end %>

<div class="statset mt3 mb2">
  <div class="stat stat--small">
    <span class="stat__label">Total</span>
    <span class="stat__value"><%= render_money_amount @stats[:deposited] %></span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">On the way</span>
    <span class="stat__value"><%= render_money_amount @stats[:in_transit] %></span>
  </div>
  <div class="stat stat--small">
    <span class="stat__label">Refunded</span>
    <span class="stat__value"><%= render_money_amount @stats[:refunded] %></span>
  </div>
  <div>
  <% if organizer_signed_in? && @event.canonical_transactions.exists? %>
    <button
      type="button"
      <%= organizer_signed_in? ? 'data-behavior=menu_toggle aria-expanded=false tabindex=0' : 'disabled=disabled' %>
      class="btn bg-info menu__toggle overflow-visible right h5 z1" style="padding: 0.25rem 1rem;">
        <%= inline_icon 'download', size: 16 %>
        Export
        <% if organizer_signed_in? %>
          <div class="menu__content h5" data-behavior="menu_content">
          <%= link_to 'Export donations (CSV)', export_donations_path(event: @event, format: :csv), target: :_blank %>
          <%= link_to 'Export donations (JSON)', export_donations_path(event: @event, format: :json), target: :_blank %>
          </div>
        <% end %>
    </button>
  <% end %>
  </div>
</div>

<hr>

<% if @recurring_donations.size > 0 %>
  <h2>Recurring donors</h2>
  <div class="table-container mb3">
    <table>
      <thead>
        <tr>
          <th></th>
          <th>Started on</th>
          <th>Name</th>
          <th>Amount</th>
          <th>Total donated</th>
        </tr>
      </thead>
      <tbody>
        <% @recurring_donations.each do |recurring_donation| %>
          <tr>
            <td style="width: 1%"><span class="ml0 mr1 badge bg-success"><%= recurring_donation.stripe_status.humanize %></span></td>
            <td><%= format_date recurring_donation.created_at %></td>
            <td class="line-height-3">
              <%= recurring_donation.name %><br>
              <% if organizer_signed_in? %>
                <span class="muted h5"><%= recurring_donation.email %></span>
              <% end %>
            </td>
            <td>
              <%= render_money recurring_donation.amount %><span class="muted">/month</span>
            </td>
            <td>
              <strong><%= render_money recurring_donation.total_donated %></strong>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<div style="text-align: center;">
  <%= link_to "All", "?filter=all", class: "filterbar__item", "aria-selected": !["deposited", "in_transit", "refunded"].include?(params[:filter]), role: "tab" %>
  <%= link_to "Deposited", "?filter=deposited", class: "filterbar__item", "aria-selected": params[:filter] == "deposited", role: "tab" %>
  <%= link_to "In Transit", "?filter=in_transit", class: "filterbar__item", "aria-selected": params[:filter] == "in_transit", role: "tab" %>
  <%= link_to "Refunded", "?filter=refunded", class: "filterbar__item", "aria-selected": params[:filter] == "refunded", role: "tab" %>
</div>

<%= form_with(model: nil, local: true, method: :get) do |form| %>
  <div class="filterbar flex flex-wrap items-center w-100">

    <%= form.text_field :q, placeholder: "Searchâ€¦", class: "flex-auto md-mr2 w-auto", style: "max-width: none;", value: params[:q] %>

  </div>
<% end %>

<% if @donations.size > 0 %>
<article class="table-container">

  <table>
    <thead>
      <tr>
        <th>STATUS</th>
        <th>DATE</th>
        <th>FROM</th>
        <th style="text-align: right;">AMOUNT</th>
        <th></th>
      </tr>
    </thead>

    <tbody>
      <% @donations.each do |d| %>
        <tr>
          <td>
            <span class="ml0 badge bg-<%= d.state %>"><%= d.state_text %></span>
          </td>
          <td>
            <%= format_date d.created_at %>
          </td>
          <td class="flex items-center">
            <%= d.name %>
            <% if d.recurring? %>
              <div class="line-height-0 ml1 tooltipped tooltipped--n" aria-label="Monthly donor"><%= inline_icon "transactions", size: 24, class: "muted" %></div>
            <% end %>
          </td>
          <td style="text-align: right;">
            <%= render_money(d.amount) %>
          </td>
          <td>
            <%= link_to "Details", hcb_code_url(d.local_hcb_code.hashid) if organizer_signed_in? %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

</article>

<% else %>
  <%= blankslate 'No donations yet' %>
<% end %>
