<% title "G Suite for #{@event.name.html_safe}" %>
<% page_md %>
<%= render 'nav'%>

<h1>
  G Suite <% "for #{@g_suite_application.domain}" if @g_suite_application %>
</h1>

<% case @event.g_suite_status_deprecated
when :start %>
  <p>Your event gets complementary G Suite through Hack Club Bank, at no extra cost.</p>
  <%= link_to 'Get started', new_event_g_suite_application_path(event_id: @event.slug), class: 'btn bg-success mt2' %>
<% when :under_review %>
  <p>Your G Suite is being configured for <strong><%= @g_suite_application.domain %></strong>. You’ll get an email within a day letting you know the next steps.</p>
<% when :app_accepted %>

  <% if @g_suite.verified_on_google? %>
    <article class="card mb3">
      <%= render 'g_suite_accounts/panel' %>
    </article>
  <% end %>

  <details <%= @g_suite.accounts.any? ? nil : "open" %>>
  <summary><h2 class="inline-block pb0 border-none mt0">Setup Instructions</h2></summary>
  <article class="card overflow-visible p0">
    <div class="p2 bg-success white center rounded-top">
      <%= inline_icon 'rep', size: 32 %>
      <h3 class="mt0 mb0">Your application was accepted!</h3>
      <p class="mt0">It’s time to set up your servers.</p>
    </div>
    <div class="p2 md-pl3">
      <h2 class="mt0 ml1 md-ml3">Instructions</h2>
      <style>
        table {
          max-width: 100%;
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }
      </style>
      <ol class="steps">
        <li>Sign in to your domain’s account at your domain host.</li>
        <li>Go to the settings section where you can update your domain’s MX records.
          <p class="secondary mt1 mb0">It might be called something like “Manage DNS,” “Email Settings,” or “Advanced Settings.”</p></li>
        <li>Delete any existing MX records.<br>
          <p class="secondary mt1 mb0">If you can’t delete the existing records, change their priority number to 20 or higher.</p></li>
        <li>
          <% if @g_suite %>
          <strong>Add your G Suite’s verification record</strong>. This is specific to your G Suite. Make it a <strong>TXT record</strong>, and set the value to this:
          <pre><%= organizer_signed_in? ? "google-site-verification=#{@g_suite.verification_key}" : 'REDACTED– SIGN IN TO VIEW' %></pre>
          <% else %>
          Continue to #5, but you’ll need to <strong>refresh this page later for this step</strong>.
          <% end %>
        </li>
        <li><strong>Add new DNS records</strong> for the Google mail servers.
          <p>If your domain host limits the number of MX records, just add the first 2 MX records in this table.</p>
          <table summary="This table displays server addresses for use in DNS records configured for G Suite">
            <thead>
              <tr class="bold">
                <th>Name/Host/Alias</th>
                <th>TTL</th>
                <th>Record Type</th>
                <th>Priority</th>
                <th>Value/Answer/Destination</th>
              </tr>
            </thead>
            <tbody>
              <tr class="shade-neutral">
                <td>@ <span class="muted">or leave blank</span></td>
                <td>3600</td>
                <td>TXT</td>
                <td>1</td>
                <td>v=spf1 include:_spf.google.com ~all</td>
              </tr>
              <% unless @g_suite.dkim_key.blank? %>
              <tr class="shade-neutral">
                <td>google._domainkey.<%= @g_suite.domain %></td>
                <td>3600</td>
                <td>TXT</td>
                <td>1</td>
                <td><%= @g_suite.dkim_key %></td>
              </tr>
              <tr class="shade-neutral">
                <td>_DMARC.<%= @g_suite.domain %></td>
                <td>3600</td>
                <td>TXT</td>
                <td>1</td>
                <td>v=DMARC1; p=none; rua=mailto:dmarc_report@hackclub.com; ruf=mailto:dmarc_report@hackclub.com; fo=1</td>
              </tr>
              <% end %>
              <tr class="shade-neutral">
                <td>@ <span class="muted">or leave blank</span></td>
                <td>3600</td>
                <td>MX</td>
                <td>1</td>
                <td>ASPMX.L.GOOGLE.COM.</td>
              </tr>
              <tr>
                <td>@ <span class="muted">or leave blank</span></td>
                <td>3600</td>
                <td>MX</td>
                <td>5</td>
                <td>ALT1.ASPMX.L.GOOGLE.COM.</td>
              </tr>
              <tr class="shade-neutral">
                <td>@ <span class="muted">or leave blank</span></td>
                <td>3600</td>
                <td>MX</td>
                <td>5</td>
                <td>ALT2.ASPMX.L.GOOGLE.COM.</td>
              </tr>
              <tr>
                <td>@ <span class="muted">or leave blank</span></td>
                <td>3600</td>
                <td>MX</td>
                <td>10</td>
                <td>ALT3.ASPMX.L.GOOGLE.COM.</td>
              </tr>
              <tr class="shade-neutral">
                <td>@ <span class="muted">or leave blank</span></td>
                <td>3600</td>
                <td>MX</td>
                <td>10</td>
                <td>ALT4.ASPMX.L.GOOGLE.COM.</td>
              </tr>
            </tbody>
          </table>
          <p><strong>Note:</strong> Some domain hosts use different labels for the name and value fields, and some hosts also require a trailing period at the end of the server name.</p>
        </li>
        <li>
          <% if @g_suite.configuring? %>
            <%= link_to "Verify", event_g_suite_verify_path(event_id: @event.id), method: :put, class: "btn bg-error" %>
          <% end %>

          <% if @g_suite.verifying? %>
            <span class="h4 badge">Verifying..</span>
          <% end %>

          <p class="secondary mt1 mb0">Typically, you can send and receive messages at your new G Suite email address in less than 6 hours. However, it may take 48–72 hours before you receive email at your new address. It’s no fun to wait, but the time for MX records to take effect depends on your domain host. We have no control over this.</p>
        </li>
      </ol>
    </div>
  </article>
  </details>
<% when :app_rejected %>
  <p class="error">Your application was rejected.</p>
<% when :verify_setup %>
  <p>Time to verify your G Suite setup. You and your teammates got emailed links to verify your accounts—click yours now to continue.</p>
  <%= render 'g_suite_accounts/panel' %>
<% when :done %>
  <p>Your G Suite is all set up!</p>
  <%= render 'g_suite_accounts/panel' %>
<% end %>
