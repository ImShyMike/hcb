<% title 'Home' %>
<% page_md %>

<%= render 'users/nav' if signed_in? %>

<h1 class="heading items-center md-items-baseline justify-center md-justify-between center md-left-align w-auto">
  <div>
    <span class="h3 caps secondary block">Welcome to</span>
    <span class="primary <%= "nowrap" unless fall? %> <%= "warning" if fall? %>">
      <% if fall? %>
        <span class="warning strikethrough"><span class="primary">Hack</span></span>
        Spook&nbsp;Club Bank
      <% else %>
        Hack&nbsp;Club Bank
      <% end %>
    </span>
  </div>
  <span class="badge ml0 h5 caps <%= Rails.env.development? ? 'bg-success' : by_season("", fall: "bg-warning") %>"><%= flavor_text.html_safe %></span>
</h1>

<main class="flex flex-column items-center center pb3">
  <% if signed_in? %>
    <% if @events.any? %>
      <ul
        class="grid grid--<%= "medium-" if Flipper.enabled?(:detailed_events_list_2022_10_04, current_user) %>narrow left-align w-100 mt0"
        data-controller="<%= "sortable event-sort" if Flipper.enabled?(:event_reordering_2022_10_10, current_user) %>"
        data-sortable-append-to-value="body"
        data-event-sort-organizer-positions-value="<%= @organizer_positions.pluck(:id).to_json %>"
        data-action="sortable:stop->event-sort#sort"
      >
        <% @events.not_hidden.each do |event| %>
          <%= link_to event, style: "max-width: 90vw", class: "draggable text-decoration-none" do %>
            <li class="card card--hover flex flex-column justify-between h-100 mx-auto">
              <strong class="brand-sans h3 line-height-2 mb1"><%= event.name %></strong>
              <% if Flipper.enabled?(:detailed_events_list_2022_10_04, current_user) %>
                <div class="brand-sans h4 line-height-2 mb2 flex justify-between"> 
                  <span style="white-space: nowrap;">
                    <%= inline_icon 'payment', size: 16, class: 'muted align-middle', 'aria-label': 'Dollar sign', style: 'transform: scale(2)' %>
                    <strong><%= render_money_amount(event.balance_v2_cents) %></strong>
                  </span>
                  <span>
                    <%= inline_icon 'card', size: 20, class: 'muted align-middle', 'aria-label': 'Cards', style: 'transform: scale(1.2)' %>
                    <strong><%= event.stripe_cards.count %></strong>
                  </span>
                </div>
              <% end %>
              <div class="avatar-row">
                <% event.organizer_positions.each do |position| %>
                  <%= avatar_for position.user, 24 %>
                <% end %>
              </div>
            </li>
          <% end %>
        <% end %>
        <a href="https://hackclub.com/bank/apply/?userEmail=<%= current_user.email %>&firstName=<%= current_user.first_name %>&lastName=<%= current_user.last_name %>&returningUser=Yes,%20I%20have%20used%20Hack%20Club%20Bank%20before&userPhone=<%= current_user.phone_number %>">
          <li class="card card--hover bold brand-sans flex items-center justify-center align-center h-100" style="max-width: 90vw">
            <div class="center">
              <div class="pop success mx-auto" style="display: flex; margin-bottom: 4px;">
                <%= inline_icon 'plus', size: 28 %>
              </div>
              New Project
            </div>
          </li>
        </a>
      </ul>

      <% if @events.hidden.any? %>
        <details class="w-100 left-align">
          <summary><h3 class="inline-block pb0 border-none">Hidden projects</h3></summary>
          <ul class="grid grid--narrow left-align mt0">
            <% @events.hidden.each do |event| %>
              <%= link_to event do %>
                <li class="card card--hover flex flex-column justify-between">
                  <strong class="h3 line-height-2 mb1"><%= event.name %></strong>
                  <div class="avatar-row">
                    <% event.organizer_positions.each do |position| %>
                      <%= avatar_for position.user, 24 %>
                    <% end %>
                  </div>
                </li>
              <% end %>
            <% end %>
          </ul>
        </details>
      <% end %>

    <% end %>
    <% if @invites.any? %>
      <h2 class="w-100 left-align mt3 pb0 border-none">Your pending invitations</h2>
      <ul class="grid grid--narrow left-align w-100 mt0">
        <% @invites.each do |invite| %>
          <%= link_to invite do %>
            <li class="card card--item">
              <%= status_badge 'info' %>
              <strong><%= invite.event.name %></strong>
            </li>
          <% end %>
        <% end %>
      </ul>
    <% end %>
    <% if @events.empty? && @invites.empty? && !current_user.admin? %>
      <%= blankslate 'No projects associated with your account yet.' %>
      <a href="https://hackclub.com/bank/apply/?userEmail=<%= current_user.email %>&firstName=<%= current_user.first_name %>&lastName=<%= current_user.last_name %>&returningUser=No,%20first%20time!&userPhone=<%= current_user.phone_number %>" class="btn bg-success">
        <%= inline_icon 'plus' %>
        New project
      </a>
    <% end %>
  <% end %>

  <% admin_tools('w-100 center mt3') do %>
    <p>
      <%= content_tag :strong, render_money(@transaction_volume) %>
      in transactions & countingâ€¦
    </p>

    <h2>Tasks & Perks</h2>
    <ul class="grid left-align w-100 mt0">
      <%= react_component 'admin_task/Card', human_name: 'Applications', task_name: :pending_bank_applications_airtable, task_path: link_to_airtable_task(:bank_applications) %>
      <%= card_to "Ledger (#{CanonicalTransaction.not_stripe_top_up.unmapped.count})", ledger_admin_index_path %>
      <%= card_to "ACH (#{AchTransfer.pending.count})", ach_admin_index_path %>
      <%= card_to "Check (#{Check.in_transit.count + Check.admin_count_offset})", check_admin_index_path %>
      <%= react_component 'admin_task/Card', human_name: 'Wires', task_name: :pending_wire_transfers_airtable, task_path: link_to_airtable_task(:wire_transfers) %>
      <%= react_component 'admin_task/Card', human_name: 'PayPal', task_name: :pending_paypal_transfers_airtable, task_path: link_to_airtable_task(:paypal_transfers) %>
      <%= card_to "Disbursements (#{Disbursement.reviewing.count})", disbursements_admin_index_path %>
      <%= card_to "Google Workspaces (#{GSuite.needs_ops_review.count})", google_workspaces_admin_index_path %>
      <%= card_to "Deletion Requests (#{OrganizerPositionDeletionRequest.under_review.count})", organizer_position_deletion_requests_path %>
      <%= react_component 'admin_task/Card', human_name: 'Disputes', task_name: :pending_disputed_transactions_airtable, task_path: link_to_airtable_task(:disputed_transactions) %>
      <%= react_component 'admin_task/Card', human_name: 'Feedback', task_name: :pending_feedback_airtable, task_path: link_to_airtable_task(:feedback) %>
      <%= react_component 'admin_task/Card', human_name: 'Stickers', task_name: :pending_stickers_airtable, task_path: link_to_airtable_task(:stickers) %>
      <%= react_component 'admin_task/Card', human_name: 'Wallets', task_name: :pending_wallets_airtable, task_path: link_to_airtable_task(:wallets) %>
      <%= react_component 'admin_task/Card', human_name: 'Hackathons', task_name: :pending_hackathons_airtable, task_path: link_to_airtable_task(:hackathons) %>
      <%= react_component 'admin_task/Card', human_name: 'Sticker Mule', task_name: :pending_stickermule_airtable, task_path: link_to_airtable_task(:stickermule) %>
      <%= react_component 'admin_task/Card', human_name: 'Sendy', task_name: :pending_sendy_airtable, task_path: link_to_airtable_task(:sendy) %>
      <%= react_component 'admin_task/Card', human_name: '1Password', task_name: :pending_onepassword_airtable, task_path: link_to_airtable_task(:onepassword) %>
      <%= react_component 'admin_task/Card', human_name: 'Domains', task_name: :pending_domains_airtable, task_path: link_to_airtable_task(:domains) %>
      <%= react_component 'admin_task/Card', human_name: 'PVSA', task_name: :pending_pvsa_airtable, task_path: link_to_airtable_task(:pvsa) %>
      <%= react_component 'admin_task/Card', human_name: 'The Event Helper', task_name: :pending_theeventhelper_airtable, task_path: link_to_airtable_task(:theeventhelper) %>
      <%= react_component 'admin_task/Card', human_name: 'FIRST Grants', task_name: :pending_first_grant_airtable, task_path: link_to_airtable_task(:first_grant) %>
    </ul>

    <h2>Information</h2>
    <ul class="grid left-align w-100 mt0">
      <%= card_to "Organizations (#{Event.approved.count})", events_admin_index_path %>
      <%= card_to "Users", users_admin_index_path %>
      <%= card_to "Pending Ledger (#{CanonicalPendingTransaction.unsettled.count})", pending_ledger_admin_index_path %>
      <%= card_to "Donations", donations_admin_index_path %>
      <%= card_to "Invoices", invoices_admin_index_path %>
      <%= card_to "Sponsors", sponsors_admin_index_path %>
      <%= card_to "Bank Fees (#{BankFee.in_transit_or_pending.count})", bank_fees_admin_index_path %>
      <%= render partial: 'static_pages/card', locals: { task_path: balances_admin_index_path, human_name: 'Organization Balances' } %>
    </ul>


    <h2>Admin Tasks</h2>
    <ul class="grid left-align w-100 mt0">
      <%= card_to "Bank Accounts (#{BankAccount.failing.count})", bank_accounts_admin_index_path %>
      <%= card_to "Raw Transactions (#{RawCsvTransaction.unhashed.count})", raw_transactions_admin_index_path %>
      <%= card_to "Hashed Transactions (#{HashedTransaction.uncanonized.count})", hashed_transactions_admin_index_path %>
      <%= card_to "HCB Codes", hcb_codes_admin_index_path %>
      <%= card_to "Transaction CSVs", transaction_csvs_admin_index_path %>
      <%= card_to "Selenium Sessions", selenium_sessions_admin_index_path %>
      <%= card_to 'Duplicated (WIP)', transaction_dedupe_path %>
    </ul>

    <!--
    <h2>Partner Tasks</h2>
    <ul class="grid w-100 mt0 left-align">
      <%#= card_to "Partners (#{Partner.count})", partners_admin_index_path %>
      <%#= card_to "Partnered Signups (#{PartneredSignup.applicant_signed.count})", partnered_signups_admin_index_path %>
      <%#= card_to "Partner Organizations (#{Event.partner.count})", partner_organizations_admin_index_path %>
      <%#= card_to "Partner Donations (#{PartnerDonation.in_transit.count})", partner_donations_admin_index_path %>
    </ul>
    -->

    <h2>Other Tools</h2>
    <ul class="grid left-align w-100 mt0">
      <%= render partial: 'static_pages/card', locals: { task_path: blazer_path, human_name: 'BI tool' } %>
      <%= render partial: 'static_pages/card', locals: { task_path: bank_accounts_path, human_name: 'Bank accounts' } %>
      <%= render partial: 'static_pages/card', locals: { task_path: new_bank_account_path, human_name: 'Setup HCB' } %>
      <%= render partial: 'static_pages/card', locals: { task_path: common_documents_path, human_name: 'Common docs' } %>
      <%= card_to 'Export finances', export_finances_path, { method: :post } %>
      <%= render partial: 'static_pages/card', locals: { task_path: flipper_path, human_name: 'Flipper' } %>
    </ul>

    <details>
      <summary class="left-align">Information (old)</summary>
      <ul class="grid left-align w-100 mt0">
        <%= render partial: 'static_pages/card', locals: { task_path: events_path, human_name: 'Projects' } %>
        <%= render partial: 'static_pages/card', locals: { task_path: negative_events_path, human_name: 'Negative projects' } %>
        <%= react_component 'admin_task/Card', human_name: 'Stripe TXs', task_path: stripe_authorizations_path %>
        <%= render partial: 'static_pages/card', locals: { task_path: sponsors_path, human_name: 'Sponsors' } %>
        <%= render partial: 'static_pages/card', locals: { task_path: g_suite_accounts_path, human_name: 'Google Workspace accounts' } %>
        <%= react_component 'admin_task/Card', human_name: :bookkeeping, task_path: bookkeeping_path %>
        <%= card_to 'Emburse cards', emburse_cards_path %>
        <%= card_to 'Emburse card requests', emburse_card_requests_path %>
        <%= card_to 'Emburse transfers', emburse_transfers_path %>
        <%= card_to 'Emburse transactions', emburse_transactions_path %>
        <%= render partial: 'static_pages/card', locals: { task_path: admin_search_path, human_name: 'Search by user' } %>
        <%= render partial: 'static_pages/card', locals: { task_path: 'https://hack.af/hcb-knowledgebase', human_name: 'Knowledgebase' } %>
      </ul>
    </details>
  <% end %>
</main>
