<% title 'My inbox' %>
<% page_md %>
<%= render 'users/nav' %>

<h1 class="heading">
  Inbox
  <%= badge_for @count %>
</h1>
<% if @count == 0 %>
  <%= blankslate "No missing receipts!" %>
<% else %>
  <p class="muted h3">These are your card transactions missing receipts.</p>
<% end %>

<% @txs.group_by(&:card).each do |card, card_txs| %>
  <% if not card.hcb_codes.missing_receipt.empty? %>
    <section class="mt3 card p0">
      <h2 class="heading line-height-4 p1 pl2 mt0 ml0">
        <%= card.event.name %>
      </h2>

      <div class="table-container">
        <table>
          <tbody data-behavior="transactions">
            <% card.hcb_codes.missing_receipt.each do |hcb_code| %>
              <% if hcb_code.canonical_transactions.any? %>
                <% hcb_code.canonical_transactions.each do |ct| %>
                  <%= render partial: "canonical_transactions/canonical_transaction", locals: { ct: hcb_code, force_display_details: true } %>
                <% end %>
              <% else %>
                <% hcb_code.canonical_pending_transactions.each do |pt| %>
                  <%= render partial: "canonical_pending_transactions/canonical_pending_transaction", locals: { pt: pt, force_display_details: true } %>
                <% end %>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>

      <%#= render 'stripe_authorizations/list', stripe_authorizations: card_txs, headless: true, authorless: true %>
    </section>
  <% end %>
<% end %>
